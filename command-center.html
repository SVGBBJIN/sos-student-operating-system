<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOS ‚Äî Student Operating System</title>
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>
<!-- Google Identity Services (OAuth for Calendar/Docs/Drive) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- pdf.js v3 UMD build (v4 uses ESM which breaks Babel setup) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';}</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0a0a;--bg2:#0f0f1a;--card:#1a1a2e;--accent:#6C63FF;--accent-dim:#4a44b3;--accent-glow:rgba(108,99,255,0.15);--text:#e0e0e0;--text-dim:#888;--border:#2a2a4e;--danger:#ff4757;--success:#2ed573;--warning:#ffa502;--green:#2ed573;--blue:#45aaf2;--orange:#fd9644;--pink:#fc5c65;--teal:#2bcbba;--radius:12px;--shadow:0 4px 20px rgba(0,0,0,0.4)}
html,body{height:100%;font-size:16px}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow:hidden}
input,textarea,select,button{font-family:inherit;font-size:inherit}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--accent-dim);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes dotPulse{0%,80%,100%{opacity:0.3;transform:scale(0.8)}40%{opacity:1;transform:scale(1)}}
@keyframes breathe{0%,100%{box-shadow:0 0 30px rgba(108,99,255,0.15)}50%{box-shadow:0 0 60px rgba(108,99,255,0.35)}}
@keyframes timerRing{from{stroke-dashoffset:283}to{stroke-dashoffset:0}}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}
@keyframes toastIn{from{opacity:0;transform:translateY(-20px) translateX(-50%)}to{opacity:1;transform:translateY(0) translateX(-50%)}}
@keyframes toastOut{from{opacity:1;transform:translateY(0) translateX(-50%)}to{opacity:0;transform:translateY(-20px) translateX(-50%)}}
@keyframes peekSlideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes cardPop{from{opacity:0;transform:scale(0.95) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes gentlePulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn .3s ease}
.slide-up{animation:slideUp .3s ease}
.card-pop{animation:cardPop .25s ease}

/* SOS Layout */
#root{height:100vh;display:flex;flex-direction:column}
.sos-app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
.sos-header{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0;z-index:10}
.sos-chat-area{flex:1;overflow-y:auto;padding:16px 0;scroll-behavior:smooth}
.sos-input-area{flex-shrink:0;border-top:1px solid var(--border);background:var(--card);padding:8px 16px 12px}
.sos-msg{padding:6px 16px;display:flex;animation:slideUp .25s ease}
.sos-msg-user{justify-content:flex-end}
.sos-msg-ai{justify-content:flex-start}
.sos-bubble{max-width:80%;padding:12px 16px;border-radius:16px;font-size:0.92rem;line-height:1.55;word-break:break-word;position:relative}
.sos-bubble-user{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.sos-bubble-ai{background:var(--card);border:1px solid var(--border);border-bottom-left-radius:4px}
.sos-bubble-time{font-size:0.6rem;opacity:0.45;margin-top:4px;text-align:right}
.sos-chip{background:rgba(108,99,255,0.1);border:1px solid rgba(108,99,255,0.25);color:var(--accent);padding:6px 14px;border-radius:20px;font-size:0.82rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.sos-chip:hover{background:rgba(108,99,255,0.2);border-color:var(--accent)}
.sos-chip:active{transform:scale(0.96)}

/* Confirmation Card */
.confirm-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:4px 0;max-width:360px;animation:cardPop .25s ease}
.confirm-card-field{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:0.85rem}
.confirm-card-label{color:var(--text-dim);font-size:0.78rem}
.confirm-card-value{font-weight:600}
.confirm-card-actions{display:flex;gap:8px;margin-top:10px}
.confirm-btn{padding:7px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:0.82rem;transition:all .15s}
.confirm-btn:active{transform:scale(0.96)}
.confirm-btn-yes{background:var(--success);color:#fff}
.confirm-btn-edit{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.confirm-btn-cancel{background:transparent;border:1px solid var(--danger);color:var(--danger);font-size:0.78rem;padding:5px 10px}

/* Edit fields inside confirmation card */
.confirm-edit-row{display:flex;gap:6px;margin-bottom:6px;align-items:center}
.confirm-edit-input{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-size:0.85rem;outline:none;flex:1}
.confirm-edit-input:focus{border-color:var(--accent)}

/* Content Cards */
.content-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:4px 0;max-width:420px;animation:cardPop .25s ease}
.content-card-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.content-card-title{font-weight:700;font-size:0.88rem;color:var(--accent)}
.content-card-subject{font-size:0.72rem;color:var(--text-dim)}
.content-card-actions{display:flex;gap:8px;margin-top:12px}

/* Flashcard */
.fc-container{perspective:600px;width:100%;height:160px;cursor:pointer;margin-bottom:8px}
.fc-inner{position:relative;width:100%;height:100%;transition:transform 0.5s;transform-style:preserve-3d}
.fc-inner.flipped{transform:rotateY(180deg)}
.fc-front,.fc-back{position:absolute;inset:0;backface-visibility:hidden;border-radius:12px;display:flex;align-items:center;justify-content:center;padding:16px;text-align:center;font-size:0.9rem;line-height:1.5}
.fc-front{background:linear-gradient(135deg,var(--card),var(--bg2));border:1px solid var(--border)}
.fc-back{background:linear-gradient(135deg,rgba(108,99,255,0.12),var(--bg2));border:1px solid var(--accent-dim);transform:rotateY(180deg);color:var(--success);font-weight:600}
.fc-nav{display:flex;align-items:center;justify-content:space-between;gap:8px}
.fc-nav-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:8px;width:36px;height:36px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .15s}
.fc-nav-btn:hover{border-color:var(--accent);color:var(--accent)}
.fc-nav-btn:disabled{opacity:0.3;cursor:not-allowed}
.fc-counter{font-size:0.8rem;color:var(--text-dim);font-weight:600}
.fc-hint{font-size:0.7rem;color:var(--text-dim);text-align:center;margin-top:6px;opacity:0.6}

/* Quiz */
.quiz-progress{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:0.78rem;color:var(--text-dim)}
.quiz-progress-bar{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.quiz-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s ease}
.quiz-question{font-size:0.92rem;font-weight:600;margin-bottom:12px;line-height:1.5}
.quiz-choices{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.quiz-choice{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;cursor:pointer;font-size:0.85rem;transition:all .15s;text-align:left}
.quiz-choice:hover{border-color:var(--accent);background:rgba(108,99,255,0.05)}
.quiz-choice.selected{border-color:var(--accent);background:rgba(108,99,255,0.1)}
.quiz-choice.correct{border-color:var(--success);background:rgba(46,213,115,0.1);color:var(--success)}
.quiz-choice.wrong{border-color:var(--danger);background:rgba(255,71,87,0.1);color:var(--danger)}
.quiz-choice.reveal-correct{border-color:var(--success);background:rgba(46,213,115,0.08)}
.quiz-score{text-align:center;padding:16px;font-size:1rem;font-weight:700;color:var(--accent)}
.quiz-btn{padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all .15s;background:var(--accent);color:#fff}
.quiz-btn:disabled{opacity:0.4;cursor:not-allowed}

/* Schedule Peek */
.peek-overlay{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);animation:overlayIn .2s ease}
.peek-panel{position:fixed;bottom:0;left:0;right:0;z-index:51;background:var(--bg);border-top:1px solid var(--border);border-radius:20px 20px 0 0;max-height:65vh;overflow-y:auto;padding:16px 20px 24px;animation:peekSlideUp .3s ease}
.peek-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px}
.peek-section{margin-bottom:16px}
.peek-section-title{font-size:0.75rem;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.peek-timeline-slot{display:flex;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.85rem}
.peek-timeline-time{width:55px;flex-shrink:0;color:var(--text-dim);font-size:0.78rem;text-align:right}
.peek-timeline-block{flex:1;padding:4px 10px;border-radius:8px;font-weight:500}
.peek-task-item{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:0.85rem}
.peek-task-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* Auth Screen */
.auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:24px;text-align:center}
.auth-form{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px 28px;width:100%;max-width:360px;animation:fadeIn .4s ease}
.auth-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-size:0.92rem;outline:none;margin-bottom:12px}
.auth-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,99,255,0.2)}
.auth-btn{width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all .15s;margin-bottom:8px}
.auth-btn:active{transform:scale(0.97)}
.auth-btn-primary{background:var(--accent);color:#fff}
.auth-btn-secondary{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.auth-error{background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.25);color:var(--danger);padding:10px 14px;border-radius:10px;font-size:0.84rem;margin-bottom:12px}
.auth-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--text-dim);font-size:0.78rem}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* Sync indicator */
.sync-dot{width:6px;height:6px;border-radius:3px;display:inline-block;margin-right:4px}
.sync-saving{background:var(--warning);animation:gentlePulse 1s infinite}
.sync-saved{background:var(--success)}
.sync-error{background:var(--danger)}

/* Google Import Modal */
.g-overlay{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);animation:overlayIn .2s ease}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}
.g-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:51;background:var(--bg);border:1px solid var(--border);border-radius:18px;width:min(92vw,440px);max-height:82vh;overflow-y:auto;padding:20px;animation:cardPop .25s ease}
.g-modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.g-modal-title{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:8px}
.g-modal-close{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:1.3rem;line-height:1;padding:2px 6px;border-radius:6px;transition:color .15s}
.g-modal-close:hover{color:var(--text)}
.g-connected{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(46,213,115,0.06);border:1px solid rgba(46,213,115,0.2);border-radius:10px;margin-bottom:12px;font-size:0.8rem}
.g-tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--bg2);border-radius:10px;padding:3px}
.g-tab{flex:1;padding:8px 4px;border:none;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:600;background:transparent;color:var(--text-dim);transition:all .15s}
.g-tab.active{background:var(--accent);color:#fff}
.g-section{padding:2px 0}
.g-btn{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);color:var(--text);cursor:pointer;font-weight:600;font-size:0.88rem;transition:all .15s;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:8px}
.g-btn:hover:not(:disabled){border-color:var(--accent);background:rgba(108,99,255,0.05)}
.g-btn:disabled{opacity:.5;cursor:not-allowed}
.g-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:0.88rem;outline:none;margin-bottom:8px;transition:border-color .15s}
.g-input:focus{border-color:var(--accent)}
.g-divider{text-align:center;color:var(--text-dim);font-size:0.78rem;margin:6px 0}
.g-event-row{display:flex;align-items:flex-start;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;margin-bottom:6px;cursor:pointer;transition:border-color .15s}
.g-event-row:hover{border-color:var(--accent-dim)}
.g-check{width:18px;height:18px;min-width:18px;border-radius:5px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;transition:all .15s;margin-top:1px}
.g-check.on{background:var(--accent);border-color:var(--accent)}
.g-event-title{font-size:0.85rem;font-weight:600;line-height:1.3}
.g-event-sub{font-size:0.75rem;color:var(--text-dim);margin-top:2px}
.g-action-row{display:flex;gap:8px;margin-top:4px}
.g-err{background:rgba(255,71,87,0.08);border:1px solid rgba(255,71,87,0.25);color:var(--danger);padding:8px 12px;border-radius:10px;font-size:0.82rem;margin-bottom:10px}
.g-note{font-size:0.8rem;color:var(--text-dim);margin-bottom:10px;line-height:1.5}
.g-status{text-align:center;padding:16px;font-size:0.82rem;color:var(--text-dim)}
.g-hdr-btn{background:rgba(108,99,255,0.1);border:1px solid rgba(108,99,255,0.25);color:var(--accent);cursor:pointer;border-radius:8px;padding:5px 10px;font-size:0.78rem;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:4px}
.g-hdr-btn:hover{background:rgba(108,99,255,0.2)}
.g-hdr-btn.connected{background:rgba(46,213,115,0.1);border-color:rgba(46,213,115,0.3);color:var(--success)}

/* Responsive */
@media(max-width:768px){
  .sos-bubble{max-width:88%}
  .sos-header h1{font-size:1rem!important}
  .peek-panel{max-height:75vh}
}
@media(max-width:500px){
  .sos-input-area{padding:6px 10px 10px}
  .sos-bubble{max-width:92%;font-size:0.88rem}
  .sos-chip{font-size:0.78rem;padding:5px 11px}
  .auth-form{padding:24px 20px}
}
input:focus,select:focus,textarea:focus{border-color:var(--accent)!important;box-shadow:0 0 0 2px rgba(108,99,255,0.2)}
button:hover{opacity:0.88}
button:active{transform:scale(0.97)}
select option{background:#0f0f23;color:var(--text)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE CONFIG
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SUPABASE_URL = 'https://evqylqgkzlbbrvogxsjn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2cXlscWdremxiYnJ2b2d4c2puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzQ1NTUsImV4cCI6MjA4Njg1MDU1NX0.NDpkE7367X5b3fhBpY268qJR6q8q2xQYs5tKL8RyIDQ';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Edge Function URL for secure Groq proxy */
const EDGE_FN_URL = SUPABASE_URL + '/functions/v1/sos-chat';

/* ‚îÄ‚îÄ‚îÄ Date helpers ‚îÄ‚îÄ‚îÄ */
function fmt(d) { return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric' }); }
function fmtFull(d) { return new Date(d).toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' }); }
function toDateStr(d) {
  const dt = new Date(d);
  return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
}
function today() { return toDateStr(new Date()); }
function daysUntil(dateStr) {
  const now = new Date(); now.setHours(0,0,0,0);
  const target = new Date(dateStr + 'T00:00:00');
  return Math.round((target - now) / 86400000);
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function fmtTime(h, m) {
  const hr = h > 12 ? h - 12 : h === 0 ? 12 : h;
  const ampm = h >= 12 ? 'PM' : 'AM';
  return hr + ':' + String(m).padStart(2,'0') + ' ' + ampm;
}

/* ‚îÄ‚îÄ‚îÄ Nudge Engine ‚îÄ‚îÄ‚îÄ */
function getNudge(task) {
  if (task.status === 'done') return { emoji:'done', text:'Done! Nice work.' };
  const d = daysUntil(task.dueDate);
  if (d < 0) return { emoji:'overdue', text:'Overdue by ' + Math.abs(d) + ' day' + (Math.abs(d)>1?'s':'') };
  if (d === 0) return { emoji:'today', text:'Due today' };
  if (d === 1) return { emoji:'tomorrow', text:'Due tomorrow' };
  if (d <= 3) return { emoji:'soon', text:d + ' days left' };
  if (d <= 7) return { emoji:'week', text:d + ' days left' };
  return { emoji:'chill', text:d + ' days left' };
}

function getPriority(task) {
  if (task.status === 'done') return 999;
  const d = daysUntil(task.dueDate);
  let score = d;
  if (task.status === 'not_started') score -= 2;
  if (task.status === 'in_progress') score -= 1;
  return score;
}

/* ‚îÄ‚îÄ‚îÄ Category Colors ‚îÄ‚îÄ‚îÄ */
const CAT_COLORS = {
  school:'var(--accent)', swim:'var(--teal)', debate:'var(--orange)',
  'free time':'var(--green)', sleep:'var(--blue)', other:'var(--pink)',
  homework:'var(--accent)', test:'var(--danger)', practice:'var(--teal)',
  event:'var(--orange)'
};
function catColor(cat) { return CAT_COLORS[cat?.toLowerCase()] || 'var(--accent)'; }

/* ‚îÄ‚îÄ‚îÄ Weather Icons ‚îÄ‚îÄ‚îÄ */
function weatherEmoji(code) {
  if (code <= 1) return '‚òÄÔ∏è'; if (code <= 3) return '‚òÅÔ∏è';
  if (code <= 48) return 'üå´Ô∏è'; if (code <= 67) return 'üåßÔ∏è';
  if (code <= 77) return 'üå®Ô∏è'; if (code <= 82) return 'üå¶Ô∏è';
  return '‚õàÔ∏è';
}

const CHAT_MAX_MESSAGES = 60;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE DATA LAYER
   Reads from / writes to Supabase. Falls back to
   localStorage if offline or not logged in.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Convert DB row ‚Üí app shape */
function dbTaskToApp(row) {
  return {
    id: row.id, title: row.title, subject: row.subject || '',
    dueDate: row.due_date, estTime: row.est_time || 30,
    status: row.status || 'not_started', focusMinutes: row.focus_minutes || 0,
    completedAt: row.completed_at, createdAt: row.created_at
  };
}
function appTaskToDb(t, userId) {
  return {
    id: t.id, user_id: userId, title: t.title, subject: t.subject || '',
    due_date: t.dueDate, est_time: t.estTime || 30,
    status: t.status || 'not_started', focus_minutes: t.focusMinutes || 0,
    completed_at: t.completedAt || null, created_at: t.createdAt || new Date().toISOString()
  };
}
function dbEventToApp(row) {
  return {
    id: row.id, title: row.title, type: row.event_type || 'other',
    subject: row.subject || '', date: row.event_date,
    recurring: row.recurring || 'none', createdAt: row.created_at
  };
}
function appEventToDb(e, userId) {
  return {
    id: e.id, user_id: userId, title: e.title, event_type: e.type || 'other',
    subject: e.subject || '', event_date: e.date,
    recurring: e.recurring || 'none', created_at: e.createdAt || new Date().toISOString()
  };
}
function dbNoteToApp(row) {
  return { id: row.id, name: row.name, content: row.content || '', updatedAt: row.updated_at };
}
function appNoteToDb(n, userId) {
  return { id: n.id, user_id: userId, name: n.name, content: n.content || '', updated_at: n.updatedAt || new Date().toISOString() };
}

/* Full load from Supabase */
async function loadAllFromSupabase(userId) {
  try {
    const [tasksRes, eventsRes, notesRes, chatRes, recurringRes, dateBlocksRes, profileRes] = await Promise.all([
      sb.from('tasks').select('*').eq('user_id', userId),
      sb.from('events').select('*').eq('user_id', userId),
      sb.from('notes').select('*').eq('user_id', userId),
      sb.from('chat_messages').select('*').eq('user_id', userId).order('created_at', { ascending: true }).limit(CHAT_MAX_MESSAGES),
      sb.from('recurring_blocks').select('*').eq('user_id', userId),
      sb.from('date_blocks').select('*').eq('user_id', userId),
      sb.from('profiles').select('*').eq('id', userId).single()
    ]);

    const tasks = (tasksRes.data || []).map(dbTaskToApp);
    const events = (eventsRes.data || []).map(dbEventToApp);
    const notes = (notesRes.data || []).map(dbNoteToApp);
    const messages = (chatRes.data || []).map(m => ({ role: m.role, content: m.content, timestamp: new Date(m.created_at).getTime() }));

    // Reconstruct blocks object from recurring_blocks + date_blocks
    const recurring = (recurringRes.data || []).map(rb => ({
      id: rb.id, name: rb.name, category: rb.category,
      start: rb.start_time?.slice(0,5) || '00:00',
      end: rb.end_time?.slice(0,5) || '01:00',
      days: rb.days || []
    }));
    const dates = {};
    (dateBlocksRes.data || []).forEach(db => {
      if (!dates[db.block_date]) dates[db.block_date] = {};
      dates[db.block_date][db.time_slot] = db.name === null ? null : { name: db.name, category: db.category || 'school' };
    });
    const blocks = { recurring, dates };

    const weatherCoords = profileRes.data
      ? { lat: profileRes.data.weather_lat || 42.33, lon: profileRes.data.weather_lon || -71.21 }
      : { lat: 42.33, lon: -71.21 };

    return { tasks, events, notes, messages, blocks, weatherCoords };
  } catch (e) {
    console.error('Failed to load from Supabase:', e);
    return null;
  }
}

/* ‚îÄ‚îÄ Name resolver: translates fuzzy AI names ‚Üí real objects with IDs ‚îÄ‚îÄ */
// Common abbreviations teens use ‚Üí expanded form
const SUBJECT_ALIASES = {
  calc:'calculus', math:'mathematics', bio:'biology', chem:'chemistry',
  phys:'physics', eng:'english', hist:'history', sci:'science', span:'spanish',
  econ:'economics', psych:'psychology', gov:'government', geo:'geography',
  pe:'physical education', gym:'physical education', lit:'literature',
  cs:'computer science', comp:'computer science', la:'language arts'
};

function normalize(str) {
  if (!str) return '';
  let s = str.toLowerCase().trim();
  // expand known abbreviations
  Object.entries(SUBJECT_ALIASES).forEach(([short, long]) => {
    s = s.replace(new RegExp('\\b' + short + '\\b', 'g'), long);
  });
  return s;
}

// Score how well two strings match (higher = better, 0 = no match)
function matchScore(query, target) {
  const q = normalize(query);
  const t = normalize(target);
  if (!q || !t) return 0;
  if (q === t) return 100;               // exact match
  if (t.includes(q)) return 80;          // target contains query ("Math Test" contains "math")
  if (q.includes(t)) return 70;          // query contains target ("cancel the math test" contains "math test")
  // word overlap ‚Äî how many query words appear in target
  const qWords = q.split(/\s+/);
  const tWords = t.split(/\s+/);
  const overlap = qWords.filter(w => tWords.some(tw => tw.includes(w) || w.includes(tw))).length;
  if (overlap > 0) return 30 + (overlap / qWords.length) * 40;
  return 0;
}

// Find the best-matching event from the array. Returns the event object or null.
function resolveEvent(nameOrId, eventsList) {
  if (!nameOrId || !eventsList?.length) return null;
  // 1. Try exact ID match first
  const byId = eventsList.find(ev => ev.id === nameOrId);
  if (byId) return byId;
  // 2. Score every event by name similarity, pick the best
  let best = null, bestScore = 0;
  for (const ev of eventsList) {
    const s = matchScore(nameOrId, ev.title);
    if (s > bestScore) { bestScore = s; best = ev; }
  }
  return bestScore >= 30 ? best : null;
}

// Find the best-matching task from the array. Returns the task object or null.
function resolveTask(nameOrId, tasksList) {
  if (!nameOrId || !tasksList?.length) return null;
  const byId = tasksList.find(t => t.id === nameOrId);
  if (byId) return byId;
  let best = null, bestScore = 0;
  for (const t of tasksList) {
    const s = matchScore(nameOrId, t.title);
    if (s > bestScore) { bestScore = s; best = t; }
  }
  return bestScore >= 30 ? best : null;
}

/* ‚îÄ‚îÄ Individual save helpers (fire-and-forget) ‚îÄ‚îÄ */
async function dbUpsertTask(task, userId) {
  const { error } = await sb.from('tasks').upsert(appTaskToDb(task, userId), { onConflict: 'id' });
  if (error) console.error('Task upsert error:', error);
}
async function dbDeleteTask(taskId, userId) {
  const { error } = await sb.from('tasks').delete().eq('id', taskId).eq('user_id', userId);
  if (error) console.error('Task delete error:', error);
}
async function dbUpsertEvent(event, userId) {
  const { error } = await sb.from('events').upsert(appEventToDb(event, userId), { onConflict: 'id' });
  if (error) console.error('Event upsert error:', error);
}
async function dbUpsertNote(note, userId) {
  const { error } = await sb.from('notes').upsert(appNoteToDb(note, userId), { onConflict: 'id' });
  if (error) console.error('Note upsert error:', error);
}
async function dbInsertChatMsg(role, content, userId) {
  const { error } = await sb.from('chat_messages').insert({ user_id: userId, role, content });
  if (error) console.error('Chat insert error:', error);
}
async function dbClearChat(userId) {
  const { error } = await sb.from('chat_messages').delete().eq('user_id', userId);
  if (error) console.error('Chat clear error:', error);
}
async function dbUpsertDateBlock(date, timeSlot, data, userId) {
  const row = {
    user_id: userId, block_date: date, time_slot: timeSlot,
    name: data ? data.name : null, category: data ? (data.category || 'school') : 'school'
  };
  const { error } = await sb.from('date_blocks').upsert(row, { onConflict: 'user_id,block_date,time_slot' });
  if (error) console.error('Date block upsert error:', error);
}

/* ‚îÄ‚îÄ Migrate localStorage ‚Üí Supabase (first login) ‚îÄ‚îÄ */
async function migrateLocalStorage(userId) {
  const migrated = localStorage.getItem('sos_migrated_' + userId);
  if (migrated) return false;

  try {
    // Tasks
    const localTasks = JSON.parse(localStorage.getItem('cc_tasks') || '[]');
    if (localTasks.length > 0) {
      const rows = localTasks.map(t => appTaskToDb(t, userId));
      await sb.from('tasks').upsert(rows, { onConflict: 'id' });
    }

    // Events
    const localEvents = JSON.parse(localStorage.getItem('cc_events') || '[]');
    if (localEvents.length > 0) {
      const rows = localEvents.map(e => appEventToDb(e, userId));
      await sb.from('events').upsert(rows, { onConflict: 'id' });
    }

    // Notes
    const localNotes = JSON.parse(localStorage.getItem('cc_notes') || '[]');
    if (localNotes.length > 0) {
      const rows = localNotes.map(n => appNoteToDb(n, userId));
      await sb.from('notes').upsert(rows, { onConflict: 'id' });
    }

    // Chat messages
    const localChat = JSON.parse(localStorage.getItem('cc_chat') || '[]');
    if (localChat.length > 0) {
      const rows = localChat.map(m => ({ user_id: userId, role: m.role, content: m.content }));
      await sb.from('chat_messages').insert(rows);
    }

    // Blocks (recurring + date overrides)
    const localBlocks = JSON.parse(localStorage.getItem('cc_blocks') || '{"recurring":[],"dates":{}}');
    if (localBlocks.recurring?.length > 0) {
      const rows = localBlocks.recurring.map(rb => ({
        user_id: userId, name: rb.name, category: rb.category || 'school',
        start_time: rb.start || '00:00', end_time: rb.end || '01:00', days: rb.days || []
      }));
      await sb.from('recurring_blocks').insert(rows);
    }
    if (localBlocks.dates && Object.keys(localBlocks.dates).length > 0) {
      const rows = [];
      Object.entries(localBlocks.dates).forEach(([date, slots]) => {
        Object.entries(slots).forEach(([slot, data]) => {
          rows.push({
            user_id: userId, block_date: date, time_slot: slot,
            name: data ? data.name : null, category: data ? (data.category || 'school') : 'school'
          });
        });
      });
      if (rows.length > 0) await sb.from('date_blocks').upsert(rows, { onConflict: 'user_id,block_date,time_slot' });
    }

    // Weather coords
    const localCoords = JSON.parse(localStorage.getItem('cc_weather_coords') || 'null');
    if (localCoords) {
      await sb.from('profiles').update({ weather_lat: localCoords.lat, weather_lon: localCoords.lon }).eq('id', userId);
    }

    localStorage.setItem('sos_migrated_' + userId, 'true');
    console.log('Migration complete');
    return true;
  } catch (e) {
    console.error('Migration error:', e);
    return false;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SOS SYSTEM PROMPT BUILDER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSystemPrompt(tasks, blocks, events, notes, tier = 2) {
  const todayStr = new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });
  const todayKey = today();
  const currentHour = new Date().getHours();

  const todayBlocks = {};
  const todayDow = new Date().getDay();
  (blocks.recurring || []).forEach(rb => {
    if (rb.days.includes(todayDow)) {
      const [sh, sm] = rb.start.split(':').map(Number);
      const [eh, em] = rb.end.split(':').map(Number);
      let ch = sh, cm = sm;
      while (ch < eh || (ch === eh && cm < em)) {
        const key = String(ch).padStart(2,'0') + ':' + String(cm).padStart(2,'0');
        todayBlocks[key] = { name: rb.name, category: rb.category };
        cm += 30; if (cm >= 60) { ch++; cm = 0; }
      }
    }
  });
  const dateOverrides = blocks.dates?.[todayKey] || {};
  Object.entries(dateOverrides).forEach(([k, v]) => {
    if (v === null) delete todayBlocks[k]; else todayBlocks[k] = v;
  });

  const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const weekSummary = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(); d.setDate(d.getDate() - d.getDay() + i);
    const ds = toDateStr(d); const dow = d.getDay(); const activities = [];
    (blocks.recurring || []).forEach(rb => {
      if (rb.days.includes(dow)) activities.push(rb.name + ' ' + rb.start + '-' + rb.end);
    });
    tasks.filter(t => t.dueDate === ds && t.status !== 'done').forEach(t => activities.push('DUE: ' + t.title));
    events.filter(e => e.date === ds).forEach(e => activities.push('EVENT: ' + e.title));
    if (activities.length > 0) weekSummary.push(dayNames[dow] + ' ' + fmt(ds) + ': ' + activities.join(', '));
  }

  const activeTasks = tasks.filter(t => t.status !== 'done').sort((a,b) => getPriority(a) - getPriority(b));
  const overdueTasks = activeTasks.filter(t => daysUntil(t.dueDate) < 0);
  const upcomingEvents = events.filter(ev => { const d = daysUntil(ev.date); return d >= 0 && d <= 14; }).map(ev => ev.title + ' (' + ev.type + ') on ' + fmt(ev.date));
  const now = new Date(); const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay()); weekStart.setHours(0,0,0,0);
  const doneThisWeek = tasks.filter(t => t.status === 'done' && t.completedAt && new Date(t.completedAt) >= weekStart).length;
  const dailyLoad = {}; activeTasks.forEach(t => { dailyLoad[t.dueDate] = (dailyLoad[t.dueDate] || 0) + (t.estTime || 30); });
  const overloadedDays = Object.entries(dailyLoad).filter(([d, mins]) => mins > 120).map(([d, mins]) => fmt(d) + ' (' + mins + ' min)');
  const taskList = activeTasks.map(t =>
    '- ' + t.title + (t.subject ? ' [' + t.subject + ']' : '') +
    ' | due ' + fmt(t.dueDate) + ' (' + daysUntil(t.dueDate) + 'd)' +
    ' | ' + t.estTime + 'min | ' + t.status.replace('_',' ') + ' | id:' + t.id
  ).join('\n');

  // ‚îÄ‚îÄ Tier 1 (Llama) gets a lean prompt ‚Äî no task list to hallucinate from ‚îÄ‚îÄ
  if (tier === 1) {
    const allClear = activeTasks.length === 0 && overdueTasks.length === 0 && upcomingEvents.length === 0;
    const scheduleStr = Object.entries(todayBlocks).length > 0
      ? Object.entries(todayBlocks).sort().map(([k,v]) => k + ' ' + v.name).join(', ')
      : 'nothing scheduled';
    return `You are SOS, a chill study sidekick. Talk like a supportive friend ‚Äî casual, brief (2-3 sentences max), never condescending.

TODAY: ${todayStr}
TODAY'S SCHEDULE: ${scheduleStr}
COMPLETED THIS WEEK: ${doneThisWeek} task${doneThisWeek !== 1 ? 's' : ''}
${allClear ? 'STATUS: All clear ‚Äî no overdue tasks, no upcoming events, nothing on the list.' : `ACTIVE TASKS: ${activeTasks.length} task${activeTasks.length !== 1 ? 's' : ''} pending${overdueTasks.length > 0 ? ' (' + overdueTasks.length + ' overdue)' : ''}. UPCOMING EVENTS: ${upcomingEvents.length > 0 ? upcomingEvents.join(', ') : 'none'}.`}

RULES:
1. NEVER invent specific tasks, deadlines, or events. If it's not explicitly listed above, it doesn't exist ‚Äî do not make it up.
2. Do NOT output any <action> tags. This is a chat-only response.
3. If student asks about their schedule/tasks and STATUS is "All clear", respond with an upbeat "all clear" message. Examples: "you're free! no overdue stuff, nothing coming up ‚Äî go enjoy yourself üéâ" or "all good! completely clear schedule, go take a break ‚úåÔ∏è"
4. If student asks how they're doing and there ARE tasks, just say something like "you've got [N] things on the list" without inventing specific titles.
5. Stay warm, brief, and casual.`;
  }

  return `You are SOS ‚Äî a chill, smart study companion built into the Student Operating System. You're like that one friend who's weirdly organized but never makes it weird. You talk casually, keep it brief, and genuinely care about the student's wellbeing.

VOICE & PERSONALITY:
- Talk like a supportive friend, not a teacher or assistant. Casual language, lowercase-ish energy.
- Keep responses to 2-4 sentences unless they ask for detail. No walls of text.
- Celebrate wins without being corny. Light humor when it fits.
- Never condescending. This student is smart ‚Äî they just need help managing time.
- When they're stressed, be calming. When they're procrastinating, be gently honest.
- You're not a planner ‚Äî you're their study sidekick who happens to run their schedule.

CORE BEHAVIORS:
1. SLEEP PROTECTION: Never schedule or suggest work past 10pm. If they try to, gently push back: "that's sleep territory ‚Äî let's find time earlier."
2. TASK DECOMPOSITION: For big projects (>60 min or multi-day), suggest breaking into 2-4 smaller chunks with their own dates.
3. WORKLOAD BALANCING: If a day has 2+ hours of tasks, suggest spreading to lighter days.
4. MISSED TASK RECOVERY: For overdue tasks, don't guilt ‚Äî suggest a realistic new date. "no stress, let's just move it."
5. SMART SCHEDULING: Consider existing blocks (swim, debate, etc.) when suggesting times. Don't double-book.
6. ENCOURAGEMENT: Notice streaks, completed tasks, good planning. Mention it naturally.

TODAY: ${todayStr} (${currentHour >= 12 ? 'afternoon' : 'morning'})

ACTIVE TASKS (sorted by urgency):
${taskList || '(none)'}

${overdueTasks.length > 0 ? 'OVERDUE: ' + overdueTasks.map(t => t.title + ' (' + Math.abs(daysUntil(t.dueDate)) + 'd late)').join(', ') : ''}

TODAY'S SCHEDULE:
${Object.entries(todayBlocks).length > 0 ? Object.entries(todayBlocks).sort().map(([k, v]) => k + ' ' + v.name).join('\n') : '(nothing scheduled)'}

THIS WEEK:
${weekSummary.join('\n') || '(no scheduled activities)'}

UPCOMING EVENTS: ${upcomingEvents.join(', ') || 'none'}
${overloadedDays.length > 0 ? 'OVERLOADED DAYS: ' + overloadedDays.join(', ') : ''}
COMPLETED THIS WEEK: ${doneThisWeek} tasks

ACTIONS ‚Äî you can modify the student's data using XML action tags. Always put ONE action tag at the very end of your message. Never list or describe these actions in your visible text ‚Äî just use them silently.

FORMAT: <action>JSON_HERE</action>

AVAILABLE ACTIONS:
add_task: {"type":"add_task","title":"...","subject":"...","due":"YYYY-MM-DD","estimated_minutes":30}
complete_task: {"type":"complete_task","task_id":"..."}
update_task: {"type":"update_task","task_id":"...","title":"...","due":"YYYY-MM-DD","estimated_minutes":30}
add_block: {"type":"add_block","date":"YYYY-MM-DD","start":"HH:MM","end":"HH:MM","activity":"...","category":"school"}
add_event: {"type":"add_event","title":"...","date":"YYYY-MM-DD","event_type":"test","subject":"..."}
add_note: {"type":"add_note","tab_name":"...","content":"..."}
break_task: {"type":"break_task","parent_title":"...","subtasks":[{"title":"...","due":"YYYY-MM-DD","estimated_minutes":20}]}
delete_task: {"type":"delete_task","title":"..."}
delete_event: {"type":"delete_event","title":"..."}
update_event: {"type":"update_event","title":"...","date":"YYYY-MM-DD"}
delete_block: {"type":"delete_block","date":"YYYY-MM-DD","start":"HH:MM","end":"HH:MM"}

RULES:
1. ALWAYS output the <action> tag. Never describe what you "could" do ‚Äî just do it.
2. NEVER repeat or list these action definitions in your reply. The student should never see raw JSON or action syntax.
3. Any mention of a task, event, test, quiz, practice, homework, deadline, project = generate the tag immediately.
4. Even casual phrasing counts: "got a calc test fri" = add_event. "gotta finish essay by thursday" = add_task.
5. Best-guess missing details. Guessing > not acting. Today is ${todayKey}.
6. For day names, calculate the real YYYY-MM-DD date.
7. Respond naturally ("got it ‚Äî added your test for Friday") but the <action> tag at the end is what actually does it.
8. Categories: school, swim, debate, free time, sleep, other. Event types: homework, test, practice, event, other.
9. For delete/update: just include the "title" of the event or task ‚Äî the system will find the right one automatically. You do NOT need to guess IDs.
10. If a student mentions something that ALREADY EXISTS in UPCOMING EVENTS or ACTIVE TASKS with the same name and date, do NOT create a duplicate ‚Äî just acknowledge it.

WHEN TO USE EACH ACTION:
- "add/create/schedule/I have a test/exam/practice/I got a" ‚Üí add_event or add_task
- "done/finished/turned in/submitted/completed" ‚Üí complete_task
- "cancel/remove/delete/clear/scratch/drop/ditch/wipe/axe/nix/scrap/erase/trash/toss/yeet/bin/forget/nevermind/never mind/cut/pull/kill/purge/dump/strike" + anything ‚Üí delete_event or delete_task
- "[event] got cancelled/called off/isn't happening/no longer happening/scratch that/off the books/not gonna happen" ‚Üí delete_event
- "take [X] off/cross out [X]/wipe [X]/erase [X]" ‚Üí delete_event or delete_task
- "move/push/reschedule/change/bump/switch" + date ‚Üí update_event
- "remind me/note this/save this/remember" ‚Üí add_task or add_note

EXAMPLES:

User: "I have a math test on Friday"
You: "got it, marked your math test for Friday ‚Äî make sure to review Wednesday night! üìù"
<action>{"type":"add_event","title":"Math Test","date":"2025-01-17","event_type":"test","subject":"Math"}</action>

User: "the math test got cancelled"
You: "got it, removed it üóë"
<action>{"type":"delete_event","title":"Math Test"}</action>

User: "move bio test to friday"
You: "done ‚Äî moved your bio test to Friday üìÖ"
<action>{"type":"update_event","title":"Bio Test","date":"2025-01-17"}</action>

User: "nevermind about the history essay"
You: "no worries, removed it ‚úì"
<action>{"type":"delete_task","title":"History essay"}</action>

User: "scratch the calc test"
You: "scratched it ‚úì"
<action>{"type":"delete_event","title":"Calc Test"}</action>

User: "ditch the history essay"
You: "dropped it üóë"
<action>{"type":"delete_task","title":"History essay"}</action>

User: "clear my bio lab"
You: "cleared it üóë"
<action>{"type":"delete_event","title":"Bio Lab"}</action>

User: "the swim meet got called off"
You: "got it, wiped it from the calendar üóë"
<action>{"type":"delete_event","title":"Swim Meet"}</action>

User: "I finished the bio homework"
You: "nice work! ‚úÖ marked it done."
<action>{"type":"complete_task","task_id":"[id from ACTIVE TASKS]"}</action>

WRONG (never do this):
User: "I have a math test on Friday"
Bad: "I can add that to your calendar! Would you like me to?"
^ WRONG. You described adding instead of actually adding. Always include the <action> tag.

CONTENT CREATION ‚Äî When the student asks for study materials, flashcards, outlines, quizzes, etc., generate them using these action tags at the END of your response:

- Flashcards: <action>{"type":"create_flashcards","title":"...","subject":"...","cards":[{"q":"question","a":"answer"}]}</action>
- Outline: <action>{"type":"create_outline","title":"...","subject":"...","sections":[{"heading":"...","points":["..."]}]}</action>
- Summary: <action>{"type":"create_summary","title":"...","subject":"...","bullets":["..."]}</action>
- Study plan: <action>{"type":"create_study_plan","title":"...","subject":"...","steps":[{"step":"...","time_minutes":20,"day":"..."}]}</action>
- Quiz: <action>{"type":"create_quiz","title":"...","subject":"...","questions":[{"q":"...","choices":["A","B","C","D"],"answer":"B"}]}</action>
- Project breakdown: <action>{"type":"create_project_breakdown","title":"...","subject":"...","phases":[{"phase":"...","tasks":["..."],"deadline":"YYYY-MM-DD"}]}</action>

CONTENT RULES:
- Generate 5-10 flashcards, 3-5 outline sections, 4-6 summary bullets, 3-5 study plan steps, 4-6 quiz questions (4 choices each), 2-4 project phases by default.
- Keep content accurate and appropriate for a middle school student.
- ALWAYS include a short friendly message WITH the action tag ‚Äî don't just send the raw content tag.
- If the topic is too vague to generate good content, ask ONE short clarifying question instead of guessing.
- For study plans, reference the student's existing schedule and upcoming tasks when suggesting timing.
- The "answer" field in quiz questions must exactly match one of the "choices".
- Make flashcard answers concise (1-2 sentences max). Make quiz distractors plausible but clearly wrong.`;
}

/* ‚îÄ‚îÄ‚îÄ Action parser ‚îÄ‚îÄ‚îÄ */
function parseActions(text) {
  const actions = []; const regex = /<action>([\s\S]*?)<\/action>/g; let match;
  while ((match = regex.exec(text)) !== null) {
    try { actions.push(JSON.parse(match[1].trim())); } catch (e) { console.error('Failed to parse action:', match[1], e); }
  }
  return actions;
}
function stripActionTags(text) { return text.replace(/<action>[\s\S]*?<\/action>/g, '').trim(); }

/* ‚îÄ‚îÄ‚îÄ Multi-model message classifier ‚îÄ‚îÄ‚îÄ */
const CONTENT_TYPES = ['create_flashcards','create_outline','create_summary','create_study_plan','create_quiz','create_project_breakdown'];

function classifyMessage(text) {
  // ‚îÄ‚îÄ TIER 2 (content gen): Flashcards, quizzes, outlines, etc. ‚Üí Gemini + high tokens ‚îÄ‚îÄ
  if (/flashcard|outline|summar|study\s*plan|study\s*guide|quiz\s+me|practice\s*question|project\s*breakdown|review\s*sheet|cheat\s*sheet/i.test(text)) {
    return { provider:'gemini', model:'gemini-2.0-flash', tier:2, isContentGen:true, maxTokens:4096 };
  }

  // ‚îÄ‚îÄ TIER 2 (action): Any scheduling/task signal ‚Üí Gemini ‚îÄ‚îÄ
  // One broad pattern: if the message contains ANY date word, time word, school subject,
  // action verb, or school activity ‚Äî send to Gemini. When in doubt, Gemini handles it.
  // Gemini understands "chem thing fri", "coach moved practice", unusual phrasing, etc.
  const actionSignals = /\b(mon|tue|wed|thu|fri|sat|sun|monday|tuesday|wednesday|thursday|friday|saturday|sunday|tmrw|tmw|2morrow|tomorrow|tonight|today|this\s+week|next\s+week|\d{1,2}(am|pm|:\d\d))\b|\b(test|exam|quiz|hw|homework|essay|project|lab|report|presentation|practice|game|match|meet|tournament|scrimmage|tryout|rehearsal|class|lesson|club|appointment|deadline|due|midterm|final|paper|assignment|worksheet)\b|\b(add|schedule|remind|mark|cancel|remove|delete|clear|scratch|drop|ditch|wipe|axe|nix|scrap|erase|purge|yeet|bin|toss|dump|trash|strike|pull|cut|move|reschedule|push\s*back|postpone|bump|finish|done|completed|finished|turned\s+in|submitted|started|working\s+on|nevermind|never\s*mind|forget)\b|\b(no\s+longer|not\s+happening|called\s+off|scratch\s+that|off\s+the\s+books|take\s+off|cross\s+out)\b|\b(calc|math|bio|chem|phys|eng|hist|sci|span|french|econ|psych|gov|geo|ap\s+\w+|pe|gym)\b|\b(swim|debate|band|choir|track|soccer|basketball|baseball|football|tennis|volleyball|lacrosse|dance|drama|robotics|chess|music|tutoring)\b/i;

  if (actionSignals.test(text)) {
    return { provider:'gemini', model:'gemini-2.0-flash', tier:2, isContentGen:false, maxTokens:1024 };
  }

  // ‚îÄ‚îÄ TIER 1: Pure chat ‚Äî no scheduling signals ‚Üí Llama 8B (fast) ‚îÄ‚îÄ
  return { provider:'groq', model:'llama-3.1-8b-instant', tier:1, isContentGen:false, maxTokens:1024 };
}

/* ‚îÄ‚îÄ‚îÄ Fail-safe: extract action from user message if AI missed ‚îÄ‚îÄ‚îÄ */
function inferActionFromMessage(text) {
  const dayMap = {
    'mon':'Monday','tue':'Tuesday','wed':'Wednesday','thu':'Thursday',
    'fri':'Friday','sat':'Saturday','sun':'Sunday',
    'monday':'Monday','tuesday':'Tuesday','wednesday':'Wednesday',
    'thursday':'Thursday','friday':'Friday','saturday':'Saturday','sunday':'Sunday',
    'tmrw':'tomorrow','tmw':'tomorrow','2morrow':'tomorrow','tomorrow':'tomorrow',
    'today':'today','2day':'today'
  };

  let inferredDate = null;
  // Check for "next week" first
  if (/next\s+week/i.test(text)) {
    const d = new Date(); d.setDate(d.getDate() + 7);
    inferredDate = toDateStr(d);
  } else {
    for (const [abbr, full] of Object.entries(dayMap)) {
      if (new RegExp('\\b' + abbr + '\\b', 'i').test(text)) {
        if (full === 'today') {
          inferredDate = today();
        } else if (full === 'tomorrow') {
          const d = new Date(); d.setDate(d.getDate() + 1);
          inferredDate = toDateStr(d);
        } else {
          const dayIndex = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].indexOf(full);
          const d = new Date(); const current = d.getDay();
          let diff = dayIndex - current;
          if (diff <= 0) diff += 7;
          d.setDate(d.getDate() + diff);
          inferredDate = toDateStr(d);
        }
        break;
      }
    }
  }

  // Classify as event vs task
  const eventWords = /\b(test|exam|quiz|game|match|practice|rehearsal|tryout|meet|tournament|scrimmage|recital|lesson|appointment|meeting|class)\b/i;
  const taskWords = /\b(hw|homework|essay|project|paper|assignment|lab|report|presentation|reading|worksheet|finish|complete|do|write|study)\b/i;

  // Try to build a title ‚Äî strip scheduling noise
  let title = text.trim()
    .replace(/\b(add|create|schedule|put|mark|set\s*up|log|i\s+have|i('ve|\s+got)|got|gotta|need\s*to|have\s*to|hafta|remind\s+me\s+to|remind\s+me\s+about|on|at|by|due|this|next|my|a|an|the|for|to)\b/gi, ' ')
    .replace(/\b(mon|tue|wed|thu|fri|sat|sun|monday|tuesday|wednesday|thursday|friday|saturday|sunday|tmrw|tmw|2morrow|tomorrow|today|2day|next\s+week)\b/gi, ' ')
    .replace(/\s+/g, ' ').trim();
  if (title) title = title.charAt(0).toUpperCase() + title.slice(1);
  if (!title || title.length < 2) title = 'Untitled';

  // Detect subject abbreviations
  const subjectMap = {
    'calc':'Calculus','math':'Math','bio':'Biology','chem':'Chemistry',
    'phys':'Physics','eng':'English','hist':'History','sci':'Science',
    'span':'Spanish','french':'French','econ':'Economics','psych':'Psychology',
    'gov':'Government','geo':'Geography'
  };
  let subject = '';
  for (const [abbr, full] of Object.entries(subjectMap)) {
    if (new RegExp('\\b' + abbr + '\\b', 'i').test(text)) { subject = full; break; }
  }

  if (eventWords.test(text)) {
    return {
      type:'add_event', title:title.substring(0,60), date:inferredDate||today(),
      event_type:/test|exam|quiz/i.test(text)?'test':/practice|rehearsal|tryout|game|match|meet|tournament|scrimmage/i.test(text)?'practice':'event',
      subject
    };
  }

  if (taskWords.test(text) || /\bdue\b/i.test(text)) {
    return { type:'add_task', title:title.substring(0,60), subject, due:inferredDate||today(), estimated_minutes:30 };
  }

  // If we found a date but can't tell event vs task, default to event
  if (inferredDate) {
    return { type:'add_event', title:title.substring(0,60), date:inferredDate, event_type:'other', subject };
  }

  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH SCREEN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function AuthScreen({ onAuth }) {
  const [mode, setMode] = useState('login');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [displayName, setDisplayName] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  const [checkingSession, setCheckingSession] = useState(true);

  // Check for existing session on mount
  useEffect(() => {
    sb.auth.getSession().then(({ data: { session } }) => {
      if (session?.user) onAuth(session.user);
      else setCheckingSession(false);
    });
  }, []);

  async function handleSubmit(e) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      if (mode === 'signup') {
        const { data, error: err } = await sb.auth.signUp({
          email, password,
          options: { data: { display_name: displayName || 'Student' } }
        });
        if (err) throw err;
        if (data.user) {
          // Check if email confirmation is required
          if (data.session) {
            onAuth(data.user);
          } else {
            setError(null);
            setMode('check-email');
          }
        }
      } else {
        const { data, error: err } = await sb.auth.signInWithPassword({ email, password });
        if (err) throw err;
        if (data.user) onAuth(data.user);
      }
    } catch (err) {
      setError(err.message || 'Something went wrong');
    } finally {
      setLoading(false);
    }
  }

  if (checkingSession) {
    return (
      <div className="auth-screen">
        <div style={{ fontSize:'2rem', fontWeight:900, background:'linear-gradient(135deg, var(--accent), var(--teal))', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent', marginBottom:16 }}>SOS</div>
        <div style={{ width:24, height:24, border:'3px solid var(--border)', borderTopColor:'var(--accent)', borderRadius:'50%', animation:'spin 0.8s linear infinite' }} />
      </div>
    );
  }

  if (mode === 'check-email') {
    return (
      <div className="auth-screen">
        <div className="auth-form">
          <div style={{ fontSize:'2rem', marginBottom:8 }}>üìß</div>
          <div style={{ fontSize:'1.1rem', fontWeight:700, marginBottom:8 }}>Check your email</div>
          <div style={{ fontSize:'0.88rem', color:'var(--text-dim)', marginBottom:20, lineHeight:1.5 }}>
            We sent a confirmation link to <strong style={{ color:'var(--text)' }}>{email}</strong>. Click it, then come back and log in.
          </div>
          <button className="auth-btn auth-btn-primary" onClick={() => setMode('login')}>
            Back to login
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="auth-screen">
      <div style={{ marginBottom:24 }}>
        <div style={{ fontSize:'2.5rem', fontWeight:900, background:'linear-gradient(135deg, var(--accent), var(--teal))', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent', marginBottom:4 }}>SOS</div>
        <div style={{ fontSize:'0.85rem', color:'var(--text-dim)' }}>Student Operating System</div>
      </div>

      <form className="auth-form" onSubmit={handleSubmit}>
        <div style={{ fontSize:'1.1rem', fontWeight:700, marginBottom:16 }}>
          {mode === 'login' ? 'Welcome back' : 'Create your account'}
        </div>

        {error && <div className="auth-error">{error}</div>}

        {mode === 'signup' && (
          <input className="auth-input" type="text" placeholder="Your name" value={displayName} onChange={e => setDisplayName(e.target.value)} autoComplete="name" />
        )}
        <input className="auth-input" type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required autoComplete="email" />
        <input className="auth-input" type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} required minLength={6} autoComplete={mode === 'login' ? 'current-password' : 'new-password'} />

        <button className="auth-btn auth-btn-primary" type="submit" disabled={loading}>
          {loading ? 'Loading...' : (mode === 'login' ? 'Sign in' : 'Create account')}
        </button>

        <div className="auth-divider">or</div>

        <button type="button" className="auth-btn auth-btn-secondary"
          onClick={() => { setMode(mode === 'login' ? 'signup' : 'login'); setError(null); }}>
          {mode === 'login' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
        </button>
      </form>

      <div style={{ marginTop:16, fontSize:'0.72rem', color:'var(--text-dim)', maxWidth:300, lineHeight:1.5 }}>
        Your data syncs across all your devices. No more losing stuff when you clear your browser.
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIRMATION CARD
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function ConfirmationCard({ action, onConfirm, onCancel, isFallback }) {
  const [editing, setEditing] = useState(!!isFallback);
  const [editData, setEditData] = useState({});
  useEffect(() => { setEditData({ ...action }); }, []);

  function getCardInfo() {
    switch (action.type) {
      case 'add_task': return { icon:'üìã', label:'New Task', fields: [
        { key:'title', label:'Task', value:action.title }, { key:'subject', label:'Subject', value:action.subject||'‚Äî' },
        { key:'due', label:'Due', value:action.due?fmt(action.due):'No date' }, { key:'estimated_minutes', label:'Time', value:(action.estimated_minutes||30)+' min' }
      ]};
      case 'add_event': return { icon:'üìÖ', label:'New Event', fields: [
        { key:'title', label:'Event', value:action.title }, { key:'date', label:'Date', value:action.date?fmt(action.date):'No date' },
        { key:'event_type', label:'Type', value:action.event_type||'other' }, { key:'subject', label:'Subject', value:action.subject||'‚Äî' }
      ]};
      case 'add_block': return { icon:'üóì', label:'Schedule Block', fields: [
        { key:'activity', label:'Activity', value:action.activity }, { key:'date', label:'Date', value:action.date?fmt(action.date):'Today' },
        { key:'time', label:'Time', value:(action.start||'?')+' - '+(action.end||'?') }, { key:'category', label:'Category', value:action.category||'school' }
      ]};
      case 'complete_task': return { icon:'‚úÖ', label:'Complete Task', fields: [{ key:'task_id', label:'Task ID', value:action.task_id }] };
      case 'break_task': return { icon:'‚úÇÔ∏è', label:'Break Into Parts', fields: [
        { key:'parent_title', label:'Project', value:action.parent_title }, { key:'subtasks', label:'Parts', value:(action.subtasks||[]).length+' sub-tasks' }
      ]};
      case 'delete_task': return { icon:'üóë', label:'Delete Task', fields: [
        { key:'title', label:'Task', value:action.title||action.task_id||'Unknown' }
      ]};
      case 'delete_event': return { icon:'üóë', label:'Delete Event', fields: [
        { key:'title', label:'Event', value:action.title||action.event_id||'Unknown' }
      ]};
      case 'update_event': return { icon:'üìÖ', label:'Update Event', fields: [
        { key:'title', label:'Event', value:action.title||'(unchanged)' }, { key:'date', label:'New Date', value:action.date?fmt(action.date):'(unchanged)' },
        { key:'event_type', label:'Type', value:action.event_type||'(unchanged)' }
      ]};
      case 'delete_block': return { icon:'üóë', label:'Remove Block', fields: [
        { key:'date', label:'Date', value:action.date?fmt(action.date):'?' }, { key:'time', label:'Time', value:(action.start||'?')+' - '+(action.end||'?') }
      ]};
      default: return { icon:'‚ö°', label:'Action', fields: Object.entries(action).filter(([k])=>k!=='type').map(([k,v])=>({key:k,label:k,value:String(v)})) };
    }
  }
  const info = getCardInfo();

  return (
    <div className="confirm-card card-pop">
      {isFallback && (
        <div style={{fontSize:'0.75rem',color:'#f0a050',marginBottom:8,padding:'4px 8px',background:'rgba(240,160,80,0.1)',borderRadius:6}}>
          ü§î I think you want to add this ‚Äî check the details?
        </div>
      )}
      <div style={{ display:'flex', alignItems:'center', gap:8, marginBottom:10 }}>
        <span style={{ fontSize:'1.1rem' }}>{info.icon}</span>
        <span style={{ fontWeight:700, fontSize:'0.88rem', color:'var(--accent)' }}>{info.label}</span>
      </div>
      {!editing ? info.fields.map(f => (
        <div key={f.key} className="confirm-card-field">
          <span className="confirm-card-label">{f.label}</span>
          <span className="confirm-card-value">{f.value}</span>
        </div>
      )) : (
        <div>
          {(action.type === 'add_task') && <>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Title</span><input className="confirm-edit-input" value={editData.title||''} onChange={e=>setEditData(p=>({...p,title:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Due</span><input className="confirm-edit-input" type="date" value={editData.due||''} onChange={e=>setEditData(p=>({...p,due:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Mins</span><input className="confirm-edit-input" type="number" min="5" step="5" value={editData.estimated_minutes||30} onChange={e=>setEditData(p=>({...p,estimated_minutes:Number(e.target.value)}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Class</span><input className="confirm-edit-input" value={editData.subject||''} onChange={e=>setEditData(p=>({...p,subject:e.target.value}))} placeholder="e.g. Math"/></div>
          </>}
          {(action.type === 'add_event') && <>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Title</span><input className="confirm-edit-input" value={editData.title||''} onChange={e=>setEditData(p=>({...p,title:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Date</span><input className="confirm-edit-input" type="date" value={editData.date||''} onChange={e=>setEditData(p=>({...p,date:e.target.value}))}/></div>
          </>}
          {(action.type === 'add_block') && <>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>What</span><input className="confirm-edit-input" value={editData.activity||''} onChange={e=>setEditData(p=>({...p,activity:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Date</span><input className="confirm-edit-input" type="date" value={editData.date||''} onChange={e=>setEditData(p=>({...p,date:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>Start</span><input className="confirm-edit-input" type="time" value={editData.start||''} onChange={e=>setEditData(p=>({...p,start:e.target.value}))}/></div>
            <div className="confirm-edit-row"><span style={{fontSize:'0.78rem',color:'var(--text-dim)',width:50}}>End</span><input className="confirm-edit-input" type="time" value={editData.end||''} onChange={e=>setEditData(p=>({...p,end:e.target.value}))}/></div>
          </>}
        </div>
      )}
      <div className="confirm-card-actions">
        <button className="confirm-btn confirm-btn-yes" onClick={() => { editing ? onConfirm({...action,...editData}) : onConfirm(action); }}>
          {editing ? 'Save' : 'Looks good'} ‚úì
        </button>
        {!editing && action.type !== 'complete_task' && <button className="confirm-btn confirm-btn-edit" onClick={() => setEditing(true)}>Edit</button>}
        <button className="confirm-btn confirm-btn-cancel" onClick={onCancel}>‚úï</button>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONTENT DISPLAY COMPONENTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function ContentCard({ icon, title, subject, onSave, onDismiss, children }) {
  return (
    <div className="content-card card-pop">
      <div className="content-card-header">
        <span style={{ fontSize:'1.1rem' }}>{icon}</span>
        <div>
          <div className="content-card-title">{title}</div>
          {subject && <div className="content-card-subject">{subject}</div>}
        </div>
      </div>
      {children}
      <div className="content-card-actions">
        <button className="confirm-btn confirm-btn-yes" onClick={onSave}>Save to Notes</button>
        <button className="confirm-btn confirm-btn-cancel" onClick={onDismiss}>Dismiss</button>
      </div>
    </div>
  );
}

function FlashcardDisplay({ data, onSave, onDismiss }) {
  const cards = data.cards || [];
  const [idx, setIdx] = useState(0);
  const [flipped, setFlipped] = useState(false);

  if (cards.length === 0) return <ContentCard icon="üÉè" title={data.title||'Flashcards'} subject={data.subject} onSave={onSave} onDismiss={onDismiss}><div style={{color:'var(--text-dim)',fontSize:'0.85rem'}}>No cards generated.</div></ContentCard>;

  function goNext() { if (idx < cards.length - 1) { setFlipped(false); setTimeout(() => setIdx(i => i + 1), 100); } }
  function goPrev() { if (idx > 0) { setFlipped(false); setTimeout(() => setIdx(i => i - 1), 100); } }

  return (
    <ContentCard icon="üÉè" title={data.title||'Flashcards'} subject={data.subject} onSave={onSave} onDismiss={onDismiss}>
      <div className="fc-container" onClick={() => setFlipped(f => !f)}>
        <div className={'fc-inner' + (flipped ? ' flipped' : '')}>
          <div className="fc-front">
            <div>{cards[idx]?.q || 'No question'}</div>
          </div>
          <div className="fc-back">
            <div>{cards[idx]?.a || 'No answer'}</div>
          </div>
        </div>
      </div>
      <div className="fc-nav">
        <button className="fc-nav-btn" onClick={(e) => { e.stopPropagation(); goPrev(); }} disabled={idx === 0}>‚Üê</button>
        <span className="fc-counter">{idx + 1} / {cards.length}</span>
        <button className="fc-nav-btn" onClick={(e) => { e.stopPropagation(); goNext(); }} disabled={idx === cards.length - 1}>‚Üí</button>
      </div>
      <div className="fc-hint">tap card to flip</div>
    </ContentCard>
  );
}

function QuizDisplay({ data, onSave, onDismiss }) {
  const questions = data.questions || [];
  const [qIdx, setQIdx] = useState(0);
  const [selected, setSelected] = useState(null);
  const [revealed, setRevealed] = useState(false);
  const [score, setScore] = useState(0);
  const [finished, setFinished] = useState(false);

  if (questions.length === 0) return <ContentCard icon="üìù" title={data.title||'Quiz'} subject={data.subject} onSave={onSave} onDismiss={onDismiss}><div style={{color:'var(--text-dim)',fontSize:'0.85rem'}}>No questions generated.</div></ContentCard>;

  const q = questions[qIdx];
  const isCorrect = selected === q?.answer;

  function checkAnswer() {
    if (!selected || revealed) return;
    setRevealed(true);
    if (selected === q.answer) setScore(s => s + 1);
  }
  function nextQuestion() {
    if (qIdx < questions.length - 1) { setQIdx(i => i + 1); setSelected(null); setRevealed(false); }
    else setFinished(true);
  }

  return (
    <ContentCard icon="üìù" title={data.title||'Quiz'} subject={data.subject} onSave={onSave} onDismiss={onDismiss}>
      {finished ? (
        <div className="quiz-score">
          <div style={{ fontSize:'2rem', marginBottom:8 }}>{score === questions.length ? 'üéâ' : score >= questions.length * 0.7 ? 'üí™' : 'üìñ'}</div>
          <div>{score} / {questions.length} correct</div>
          <div style={{ fontSize:'0.82rem', color:'var(--text-dim)', fontWeight:400, marginTop:4 }}>
            {score === questions.length ? 'Perfect score!' : score >= questions.length * 0.7 ? 'Nice job!' : 'Keep studying, you got this!'}
          </div>
          <button className="quiz-btn" style={{ marginTop:12 }} onClick={() => { setQIdx(0); setSelected(null); setRevealed(false); setScore(0); setFinished(false); }}>Try Again</button>
        </div>
      ) : (
        <>
          <div className="quiz-progress">
            <span>{qIdx + 1}/{questions.length}</span>
            <div className="quiz-progress-bar"><div className="quiz-progress-fill" style={{ width: ((qIdx + 1) / questions.length * 100) + '%' }}/></div>
            <span style={{ color:'var(--success)' }}>{score} ‚úì</span>
          </div>
          <div className="quiz-question">{q?.q || 'No question'}</div>
          <div className="quiz-choices">
            {(q?.choices || []).map((choice, i) => {
              let cls = 'quiz-choice';
              if (revealed && choice === q.answer) cls += ' correct';
              else if (revealed && choice === selected && choice !== q.answer) cls += ' wrong';
              else if (!revealed && choice === selected) cls += ' selected';
              if (revealed && choice === q.answer && choice !== selected) cls += ' reveal-correct';
              return (
                <button key={i} className={cls} onClick={() => { if (!revealed) setSelected(choice); }}>
                  {choice}
                </button>
              );
            })}
          </div>
          <div style={{ display:'flex', gap:8 }}>
            {!revealed && <button className="quiz-btn" onClick={checkAnswer} disabled={!selected}>Check Answer</button>}
            {revealed && <button className="quiz-btn" onClick={nextQuestion}>{qIdx < questions.length - 1 ? 'Next ‚Üí' : 'See Score'}</button>}
          </div>
        </>
      )}
    </ContentCard>
  );
}

function GenericContentDisplay({ data, icon, label, onSave, onDismiss }) {
  const formatted = (() => {
    try {
      switch (data.type) {
        case 'create_summary':
          return (data.bullets||[]).map(b => '‚Ä¢ ' + b);
        case 'create_outline':
          return (data.sections||[]).flatMap(s => [{ heading: true, text: s.heading }, ...(s.points||[]).map(p => ({ heading: false, text: p }))]);
        case 'create_study_plan':
          return (data.steps||[]).map((s,i) => (i+1) + '. ' + s.step + ' ‚Äî ' + (s.time_minutes||20) + 'min' + (s.day ? ' (' + s.day + ')' : ''));
        case 'create_project_breakdown':
          return (data.phases||[]).flatMap(p => [{ heading: true, text: p.phase + (p.deadline ? ' ‚Äî due ' + fmt(p.deadline) : '') }, ...(p.tasks||[]).map(t => ({ heading: false, text: t }))]);
        default: return ['(content generated)'];
      }
    } catch(e) { return ['(error displaying content)']; }
  })();

  return (
    <ContentCard icon={icon} title={data.title||label} subject={data.subject} onSave={onSave} onDismiss={onDismiss}>
      <div style={{ maxHeight:200, overflowY:'auto', fontSize:'0.85rem', lineHeight:1.6 }}>
        {formatted.map((item, i) => {
          if (typeof item === 'string') return <div key={i} style={{ padding:'3px 0', color:'var(--text)' }}>{item}</div>;
          if (item.heading) return <div key={i} style={{ fontWeight:700, color:'var(--accent)', marginTop: i > 0 ? 8 : 0, fontSize:'0.88rem' }}>{item.text}</div>;
          return <div key={i} style={{ padding:'2px 0 2px 12px', color:'var(--text)', borderLeft:'2px solid var(--border)' }}>‚Ä¢ {item.text}</div>;
        })}
      </div>
    </ContentCard>
  );
}

function ContentTypeRouter({ content, onSave, onDismiss }) {
  switch (content.type) {
    case 'create_flashcards':
      return <FlashcardDisplay data={content} onSave={onSave} onDismiss={onDismiss} />;
    case 'create_quiz':
      return <QuizDisplay data={content} onSave={onSave} onDismiss={onDismiss} />;
    case 'create_outline':
      return <GenericContentDisplay data={content} icon="üìë" label="Outline" onSave={onSave} onDismiss={onDismiss} />;
    case 'create_summary':
      return <GenericContentDisplay data={content} icon="üìã" label="Summary" onSave={onSave} onDismiss={onDismiss} />;
    case 'create_study_plan':
      return <GenericContentDisplay data={content} icon="üìÖ" label="Study Plan" onSave={onSave} onDismiss={onDismiss} />;
    case 'create_project_breakdown':
      return <GenericContentDisplay data={content} icon="üî®" label="Project Breakdown" onSave={onSave} onDismiss={onDismiss} />;
    default:
      return <GenericContentDisplay data={content} icon="‚ö°" label="Content" onSave={onSave} onDismiss={onDismiss} />;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GOOGLE IMPORT MODAL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function GoogleImportModal({ googleToken, googleUser, onClose, onImportEvents, onImportDoc, onImportPdf, onDisconnect }) {
  const [tab, setTab] = useState('calendar');
  // Calendar tab state
  const [calEvents, setCalEvents] = useState([]);
  const [selected, setSelected] = useState(new Set());
  const [calLoading, setCalLoading] = useState(false);
  const [calFetched, setCalFetched] = useState(false);
  // Docs tab state
  const [docUrl, setDocUrl] = useState('');
  const [docLoading, setDocLoading] = useState(false);
  // PDF tab state
  const [pdfDriveUrl, setPdfDriveUrl] = useState('');
  const [pdfLoading, setPdfLoading] = useState(false);
  const fileInputRef = useRef(null);
  // Shared error
  const [err, setErr] = useState(null);

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function extractDocId(url) {
    const m = url.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);
    return m ? m[1] : null;
  }
  function extractDriveFileId(url) {
    const m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    return m ? m[1] : null;
  }
  function authHeader() { return { 'Authorization': 'Bearer ' + googleToken }; }

  // ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ
  async function fetchCalEvents() {
    setCalLoading(true); setErr(null);
    try {
      const now = new Date();
      const max = new Date(now.getTime() + 14 * 86400000);
      const params = new URLSearchParams({
        timeMin: now.toISOString(), timeMax: max.toISOString(),
        singleEvents: 'true', orderBy: 'startTime', maxResults: '50'
      });
      const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events?' + params, { headers: authHeader() });
      if (!res.ok) { if (res.status === 401) throw new Error('Google session expired ‚Äî click Reconnect.'); throw new Error('Calendar fetch failed: ' + res.status); }
      const data = await res.json();
      const evs = (data.items || []).filter(e => e.summary).map(e => ({
        googleId: e.id,
        title: e.summary,
        date: e.start?.date || (e.start?.dateTime?.split('T')[0] ?? ''),
        startTime: e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : null,
        allDay: !!e.start?.date,
      }));
      setCalEvents(evs);
      setSelected(new Set(evs.map((_,i) => i)));
      setCalFetched(true);
    } catch(e) { setErr(e.message); }
    finally { setCalLoading(false); }
  }

  function toggleEv(i) {
    setSelected(prev => { const n=new Set(prev); n.has(i)?n.delete(i):n.add(i); return n; });
  }

  // ‚îÄ‚îÄ Docs ‚îÄ‚îÄ
  async function importDoc() {
    setDocLoading(true); setErr(null);
    try {
      const id = extractDocId(docUrl);
      if (!id) throw new Error('Invalid Google Docs URL. It should look like: docs.google.com/document/d/...');
      // Export as plain text via Drive API (simpler than parsing Docs JSON)
      const res = await fetch('https://www.googleapis.com/drive/v3/files/' + id + '/export?mimeType=text/plain', { headers: authHeader() });
      if (!res.ok) {
        if (res.status === 401) throw new Error('Google session expired ‚Äî click Reconnect.');
        if (res.status === 404) throw new Error("Doc not found. Make sure you have access and the URL is correct.");
        throw new Error('Failed to fetch doc: ' + res.status);
      }
      const text = await res.text();
      if (!text.trim()) throw new Error('Document appears to be empty.');
      // Get title
      let title = 'Imported Doc';
      try {
        const meta = await fetch('https://www.googleapis.com/drive/v3/files/' + id + '?fields=name', { headers: authHeader() });
        if (meta.ok) { const m = await meta.json(); title = m.name || title; }
      } catch(_) {}
      onImportDoc(title, text.trim());
    } catch(e) { setErr(e.message); }
    finally { setDocLoading(false); }
  }

  // ‚îÄ‚îÄ PDF ‚îÄ‚îÄ
  async function importPdf(source) {
    setPdfLoading(true); setErr(null);
    try {
      const lib = window.pdfjsLib;
      if (!lib) throw new Error('PDF library is still loading ‚Äî wait a moment and try again.');
      let loadingTask;
      let filename = 'Imported PDF';
      if (source instanceof File) {
        filename = source.name.replace(/\.pdf$/i, '');
        const buf = await source.arrayBuffer();
        loadingTask = lib.getDocument({ data: buf });
      } else {
        const fileId = extractDriveFileId(source);
        if (!fileId) throw new Error('Invalid Google Drive URL. It should look like: drive.google.com/file/d/...');
        const res = await fetch('https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media', { headers: authHeader() });
        if (!res.ok) {
          if (res.status === 401) throw new Error('Google session expired ‚Äî click Reconnect.');
          if (res.status === 403) throw new Error("Can't access this file. Make sure it's shared or you have Drive access.");
          throw new Error('Failed to download PDF: ' + res.status);
        }
        const buf = await res.arrayBuffer();
        // Try to get filename from Drive
        try {
          const meta = await fetch('https://www.googleapis.com/drive/v3/files/' + fileId + '?fields=name', { headers: authHeader() });
          if (meta.ok) { const m = await meta.json(); filename = (m.name || 'Imported PDF').replace(/\.pdf$/i,''); }
        } catch(_) {}
        loadingTask = lib.getDocument({ data: buf });
      }
      const pdf = await loadingTask.promise;
      let full = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const tc = await page.getTextContent();
        full += tc.items.map(item => item.str).join(' ') + '\n\n';
      }
      const trimmed = full.trim();
      if (!trimmed) throw new Error('No readable text found in this PDF. Scanned/image-only PDFs cannot be parsed.');
      // Truncate very large docs with a note
      const maxChars = 50000;
      const content = trimmed.length > maxChars ? trimmed.slice(0, maxChars) + '\n\n[Truncated ‚Äî PDF had more content than the notes limit]' : trimmed;
      onImportPdf(filename, content);
    } catch(e) { setErr(e.message); }
    finally { setPdfLoading(false); }
  }

  const isLoading = calLoading || docLoading || pdfLoading;

  return (
    <>
      <div className="g-overlay" onClick={onClose}/>
      <div className="g-modal" onClick={e=>e.stopPropagation()}>
        {/* Header */}
        <div className="g-modal-hdr">
          <div className="g-modal-title"><span>üîó</span> Import from Google</div>
          <button className="g-modal-close" onClick={onClose} disabled={isLoading}>√ó</button>
        </div>

        {/* Connected account info */}
        {googleUser && (
          <div className="g-connected">
            <span style={{color:'var(--success)'}}>‚úì {googleUser.email}</span>
            <button onClick={onDisconnect} style={{background:'transparent',border:'none',color:'var(--danger)',cursor:'pointer',fontSize:'0.78rem',fontWeight:600,padding:'0 4px'}}>Disconnect</button>
          </div>
        )}

        {/* Error */}
        {err && <div className="g-err">‚ö†Ô∏è {err}</div>}

        {/* Tabs */}
        <div className="g-tabs">
          {['calendar','docs','pdf'].map(t=>(
            <button key={t} className={'g-tab'+(tab===t?' active':'')} onClick={()=>{setTab(t);setErr(null);}}>
              {t==='calendar'?'üìÖ Calendar':t==='docs'?'üìÑ Docs':'üìë PDF'}
            </button>
          ))}
        </div>

        {/* ‚îÄ‚îÄ Calendar Tab ‚îÄ‚îÄ */}
        {tab==='calendar' && (
          <div className="g-section">
            {!calFetched ? (
              <>
                <p className="g-note">Pull your Google Calendar events for the next 2 weeks into SOS. You can pick which ones to import.</p>
                <button className="g-btn" onClick={fetchCalEvents} disabled={calLoading}>
                  <span>{calLoading?'‚è≥':'üìÖ'}</span>
                  {calLoading ? 'Fetching events‚Ä¶' : 'Fetch next 2 weeks of events'}
                </button>
              </>
            ) : (
              <>
                {calEvents.length === 0 ? (
                  <div className="g-status">No events found in the next 2 weeks.</div>
                ) : (
                  <>
                    <div style={{fontSize:'0.78rem',color:'var(--text-dim)',marginBottom:10}}>
                      {calEvents.length} events ‚Äî tap to select/deselect.
                      <button onClick={()=>setSelected(s=>s.size===calEvents.length?new Set():new Set(calEvents.map((_,i)=>i)))}
                        style={{marginLeft:8,background:'transparent',border:'none',color:'var(--accent)',cursor:'pointer',fontSize:'0.78rem',fontWeight:600}}>
                        {selected.size===calEvents.length?'Deselect all':'Select all'}
                      </button>
                    </div>
                    {calEvents.map((ev,i)=>(
                      <div key={i} className="g-event-row" onClick={()=>toggleEv(i)}>
                        <div className={'g-check'+(selected.has(i)?' on':'')}>
                          {selected.has(i)&&<span style={{color:'#fff',fontSize:'0.7rem',fontWeight:900}}>‚úì</span>}
                        </div>
                        <div style={{flex:1}}>
                          <div className="g-event-title">{ev.title}</div>
                          <div className="g-event-sub">{fmt(ev.date)}{ev.startTime?' ¬∑ '+ev.startTime:' ¬∑ All day'}</div>
                        </div>
                      </div>
                    ))}
                    <div className="g-action-row">
                      <button className="confirm-btn confirm-btn-yes" style={{flex:1}}
                        onClick={()=>onImportEvents(calEvents.filter((_,i)=>selected.has(i)))}
                        disabled={selected.size===0}>
                        Import {selected.size} event{selected.size!==1?'s':''}
                      </button>
                      <button className="confirm-btn confirm-btn-cancel" onClick={()=>{setCalFetched(false);setCalEvents([]);}}>
                        Re-fetch
                      </button>
                    </div>
                  </>
                )}
              </>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ Docs Tab ‚îÄ‚îÄ */}
        {tab==='docs' && (
          <div className="g-section">
            <p className="g-note">Paste a Google Docs link ‚Äî the document's text will be saved as a note in SOS. Formatting (tables, images) won't carry over, just the text.</p>
            <input className="g-input" placeholder="https://docs.google.com/document/d/‚Ä¶"
              value={docUrl} onChange={e=>{setDocUrl(e.target.value);setErr(null);}} />
            <button className="confirm-btn confirm-btn-yes" style={{width:'100%'}}
              onClick={importDoc} disabled={docLoading||!docUrl.trim()}>
              {docLoading?'Importing‚Ä¶':'Import to Notes'}
            </button>
          </div>
        )}

        {/* ‚îÄ‚îÄ PDF Tab ‚îÄ‚îÄ */}
        {tab==='pdf' && (
          <div className="g-section">
            <button className="g-btn" onClick={()=>fileInputRef.current?.click()} disabled={pdfLoading}>
              <span>üíª</span> Upload PDF from your computer
            </button>
            <input ref={fileInputRef} type="file" accept=".pdf" style={{display:'none'}}
              onChange={e=>{if(e.target.files?.[0]){importPdf(e.target.files[0]);e.target.value='';}}}/>

            <div className="g-divider">‚Äî or ‚Äî</div>

            <p className="g-note">Paste a Google Drive link to a PDF (the file must be shared or you must have access).</p>
            <input className="g-input" placeholder="https://drive.google.com/file/d/‚Ä¶"
              value={pdfDriveUrl} onChange={e=>{setPdfDriveUrl(e.target.value);setErr(null);}} />
            <button className="confirm-btn confirm-btn-yes" style={{width:'100%'}}
              onClick={()=>importPdf(pdfDriveUrl)} disabled={pdfLoading||!pdfDriveUrl.trim()}>
              {pdfLoading?'Reading PDF‚Ä¶':'Import PDF to Notes'}
            </button>
            <p className="g-note" style={{marginTop:8}}>‚ö†Ô∏è Scanned/photo PDFs won't work ‚Äî only PDFs with real digital text can be read.</p>
          </div>
        )}
      </div>
    </>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCHEDULE PEEK PANEL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function SchedulePeek({ tasks, blocks, events, weatherData, onClose }) {
  const todayKey = today(); const todayDow = new Date().getDay();
  const timeline = useMemo(() => {
    const result = {};
    (blocks.recurring || []).forEach(rb => {
      if (rb.days.includes(todayDow)) {
        const [sh,sm]=rb.start.split(':').map(Number); const [eh,em]=rb.end.split(':').map(Number);
        let ch=sh,cm=sm;
        while(ch<eh||(ch===eh&&cm<em)){const key=String(ch).padStart(2,'0')+':'+String(cm).padStart(2,'0');result[key]={name:rb.name,category:rb.category};cm+=30;if(cm>=60){ch++;cm=0;}}
      }
    });
    const ov = blocks.dates?.[todayKey]||{};
    Object.entries(ov).forEach(([k,v])=>{if(v===null)delete result[k];else result[k]=v;});
    return result;
  },[blocks,todayKey,todayDow]);

  const condensed = useMemo(()=>{
    const sorted=Object.entries(timeline).sort(([a],[b])=>a.localeCompare(b));const bl=[];let cur=null;
    sorted.forEach(([time,data])=>{if(cur&&cur.name===data.name&&cur.category===data.category){cur.end=time;cur.slots++}else{if(cur)bl.push(cur);cur={start:time,end:time,name:data.name,category:data.category,slots:1}}});
    if(cur)bl.push(cur);
    return bl.map(b=>{const[eh,em]=b.end.split(':').map(Number);let nm=em+30,nh=eh;if(nm>=60){nh++;nm=0}return{...b,endDisplay:String(nh).padStart(2,'0')+':'+String(nm).padStart(2,'0')}});
  },[timeline]);

  const overduePeekTasks=useMemo(()=>tasks.filter(t=>t.status!=='done'&&daysUntil(t.dueDate)<0).sort((a,b)=>daysUntil(a.dueDate)-daysUntil(b.dueDate)),[tasks]);
  const activeTasks=useMemo(()=>tasks.filter(t=>t.status!=='done'&&daysUntil(t.dueDate)>=0).sort((a,b)=>getPriority(a)-getPriority(b)).slice(0,5),[tasks]);
  const upcomingEvents=useMemo(()=>events.filter(ev=>{const d=daysUntil(ev.date);return d>=0&&d<=7}).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,4),[events]);
  const currentHour=new Date().getHours();
  const greeting=currentHour<12?'Good morning':currentHour<17?'Good afternoon':'Good evening';

  return (<>
    <div className="peek-overlay" onClick={onClose}/>
    <div className="peek-panel">
      <div className="peek-handle"/>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
        <div><div style={{fontSize:'1.1rem',fontWeight:700}}>{greeting}</div><div style={{fontSize:'0.82rem',color:'var(--text-dim)'}}>{fmtFull(new Date())}</div></div>
        {weatherData?.current&&<div style={{display:'flex',alignItems:'center',gap:6}}><span style={{fontSize:'1.3rem'}}>{weatherEmoji(weatherData.current.weathercode)}</span><span style={{fontWeight:700}}>{Math.round(weatherData.current.temperature_2m)}¬∞F</span></div>}
      </div>
      <div className="peek-section">
        <div className="peek-section-title">Today's Schedule</div>
        {condensed.length===0?<div style={{fontSize:'0.85rem',color:'var(--text-dim)',padding:'8px 0'}}>Nothing scheduled today</div>:
        condensed.map((block,i)=>(
          <div key={i} className="peek-timeline-slot"><div className="peek-timeline-time">{fmtTime(...block.start.split(':').map(Number))}</div>
          <div className="peek-timeline-block" style={{background:catColor(block.category)+'20',borderLeft:'3px solid '+catColor(block.category)}}>{block.name}<span style={{fontSize:'0.72rem',color:'var(--text-dim)',marginLeft:8}}>{block.slots*30}min</span></div></div>
        ))}
      </div>
      {overduePeekTasks.length>0&&<div className="peek-section">
        <div className="peek-section-title" style={{color:'var(--danger)'}}>‚ö†Ô∏è Overdue ({overduePeekTasks.length})</div>
        {overduePeekTasks.map(task=>(<div key={task.id} className="peek-task-item">
          <div className="peek-task-dot" style={{background:'var(--danger)'}}/>
          <div style={{flex:1}}>
            <div style={{fontWeight:600,color:'var(--danger)'}}>{task.title}</div>
            <div style={{fontSize:'0.75rem',color:'var(--text-dim)'}}>{task.subject&&task.subject+' ¬∑ '}{Math.abs(daysUntil(task.dueDate))}d overdue{' ¬∑ '+(task.estTime||30)+'min'}</div>
          </div>
          <div style={{fontSize:'0.78rem',fontWeight:600,color:'var(--danger)'}}>{task.status==='in_progress'?'üî∂':'‚¨ú'}</div>
        </div>))}
      </div>}
      {activeTasks.length>0&&<div className="peek-section"><div className="peek-section-title">Upcoming Tasks ({activeTasks.length})</div>
        {activeTasks.map(task=>{const d=daysUntil(task.dueDate);const dotColor=d<=1?'var(--warning)':d<=3?'var(--accent)':'var(--text-dim)';
          return(<div key={task.id} className="peek-task-item"><div className="peek-task-dot" style={{background:dotColor}}/><div style={{flex:1}}><div style={{fontWeight:500}}>{task.title}</div><div style={{fontSize:'0.75rem',color:'var(--text-dim)'}}>{task.subject&&task.subject+' ¬∑ '}{d===0?'Today':d===1?'Tomorrow':fmt(task.dueDate)}{' ¬∑ '+(task.estTime||30)+'min'}</div></div><div style={{fontSize:'0.78rem',fontWeight:600,color:dotColor}}>{task.status==='in_progress'?'üî∂':'‚¨ú'}</div></div>)
        })}
      </div>}
      {upcomingEvents.length>0&&<div className="peek-section"><div className="peek-section-title">Upcoming Events</div>
        {upcomingEvents.map(ev=>(<div key={ev.id} className="peek-task-item"><div className="peek-task-dot" style={{background:catColor(ev.type)}}/><div><div style={{fontWeight:500}}>{ev.title}</div><div style={{fontSize:'0.75rem',color:'var(--text-dim)'}}>{fmt(ev.date)}{ev.subject&&' ¬∑ '+ev.subject}</div></div></div>))}
      </div>}
    </div>
  </>);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOAST
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Toast({message,onDone}){
  useEffect(()=>{const t=setTimeout(onDone,2400);return()=>clearTimeout(t)},[]);
  return(<div style={{position:'fixed',top:20,left:'50%',transform:'translateX(-50%)',zIndex:9999,padding:'10px 20px',borderRadius:12,background:'var(--success)',color:'#fff',fontWeight:600,fontSize:'0.88rem',boxShadow:'0 4px 24px rgba(46,213,115,0.4)',animation:'toastIn .3s ease, toastOut .3s ease 2.1s forwards'}}>{message}</div>);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FOCUS MODE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function FocusMode({task,onComplete,onExit,onUpdateTask}){
  const[secondsLeft,setSecondsLeft]=useState(25*60);const[totalSeconds]=useState(25*60);
  const[isRunning,setIsRunning]=useState(true);const[elapsed,setElapsed]=useState(0);
  const[showBreakPrompt,setShowBreakPrompt]=useState(false);const[onBreak,setOnBreak]=useState(false);
  const startTimeRef=useRef(Date.now());const endTimeRef=useRef(Date.now()+25*60*1000);

  useEffect(()=>{
    if(!isRunning)return;
    const iv=setInterval(()=>{
      const now=Date.now();const remaining=Math.max(0,Math.round((endTimeRef.current-now)/1000));
      setSecondsLeft(remaining);setElapsed(Math.round((now-startTimeRef.current)/1000));
      if(remaining<=0){
        setIsRunning(false);
        try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const playTone=(freq,start,dur)=>{const osc=ctx.createOscillator();const gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);osc.frequency.value=freq;osc.type='sine';gain.gain.setValueAtTime(0.3,ctx.currentTime+start);gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+start+dur);osc.start(ctx.currentTime+start);osc.stop(ctx.currentTime+start+dur)};playTone(660,0,0.25);playTone(880,0.3,0.35)}catch(e){}
        if(!onBreak){setShowBreakPrompt(true);const focusSecs=Math.round((now-startTimeRef.current)/1000);onUpdateTask(task.id,{focusMinutes:(task.focusMinutes||0)+Math.round(focusSecs/60)})}
        else{setOnBreak(false);startTimeRef.current=Date.now();endTimeRef.current=Date.now()+25*60*1000;setSecondsLeft(25*60);setIsRunning(true)}
      }
    },250);return()=>clearInterval(iv);
  },[isRunning,onBreak]);

  useEffect(()=>{function handleKey(e){if(e.key==='Escape')onExit();if(e.key===' '){e.preventDefault();togglePause()}}window.addEventListener('keydown',handleKey);return()=>window.removeEventListener('keydown',handleKey)},[isRunning]);
  function togglePause(){if(isRunning)setIsRunning(false);else{endTimeRef.current=Date.now()+secondsLeft*1000;setIsRunning(true)}}
  function startBreak(){setShowBreakPrompt(false);setOnBreak(true);startTimeRef.current=Date.now();endTimeRef.current=Date.now()+5*60*1000;setSecondsLeft(5*60);setIsRunning(true)}
  function keepGoing(){setShowBreakPrompt(false);startTimeRef.current=Date.now();endTimeRef.current=Date.now()+25*60*1000;setSecondsLeft(25*60);setIsRunning(true)}
  function handleDone(){onUpdateTask(task.id,{status:'done',completedAt:new Date().toISOString(),focusMinutes:(task.focusMinutes||0)+Math.round(elapsed/60)});onComplete()}

  const mins=Math.floor(secondsLeft/60);const secs=secondsLeft%60;
  const progress=totalSeconds>0?(1-secondsLeft/(onBreak?300:totalSeconds)):0;
  const circumference=2*Math.PI*45;
  const btnBase={border:'none',borderRadius:10,padding:'12px 24px',cursor:'pointer',fontWeight:600,fontSize:'0.92rem',transition:'all .15s'};

  return(
    <div style={{position:'fixed',inset:0,zIndex:1000,background:'#050510',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',animation:'overlayIn .4s ease'}}>
      <div style={{position:'absolute',inset:0,animation:isRunning?'breathe 4s ease-in-out infinite':'none',pointerEvents:'none'}}/>
      <div style={{textAlign:'center',marginBottom:40,position:'relative',zIndex:1}}>
        <div style={{fontSize:'1.8rem',fontWeight:700,marginBottom:8}}>{task.title}</div>
        {task.subject&&<div style={{fontSize:'1rem',color:'var(--text-dim)',marginBottom:4}}>{task.subject}</div>}
        <div style={{fontSize:'0.85rem',color:'var(--text-dim)'}}>{task.dueDate&&<span>{fmt(task.dueDate)}</span>}{task.estTime>0&&<span style={{marginLeft:12}}>{task.estTime}min estimated</span>}</div>
        {onBreak&&<div style={{marginTop:8,color:'var(--success)',fontWeight:600}}>Break time</div>}
      </div>
      <div style={{position:'relative',width:180,height:180,marginBottom:30}}>
        <svg width="180" height="180" style={{transform:'rotate(-90deg)'}}><circle cx="90" cy="90" r="45" fill="none" stroke="var(--border)" strokeWidth="6"/><circle cx="90" cy="90" r="45" fill="none" stroke={onBreak?'var(--success)':'var(--accent)'} strokeWidth="6" strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={circumference*(1-progress)} style={{transition:'stroke-dashoffset .5s ease'}}/></svg>
        <div style={{position:'absolute',inset:0,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}>
          <div style={{fontSize:'2.5rem',fontWeight:700,fontVariantNumeric:'tabular-nums'}}>{String(mins).padStart(2,'0')}:{String(secs).padStart(2,'0')}</div>
          <div style={{fontSize:'0.8rem',color:'var(--text-dim)'}}>{isRunning?(onBreak?'Break':'Focusing'):'Paused'}</div>
        </div>
      </div>
      {showBreakPrompt&&<div style={{background:'var(--card)',border:'1px solid var(--border)',borderRadius:'var(--radius)',padding:20,textAlign:'center',marginBottom:20,maxWidth:340,boxShadow:'var(--shadow)'}} className="fade-in"><div style={{fontSize:'1.1rem',fontWeight:600,marginBottom:12}}>Nice session. Take 5?</div><div style={{display:'flex',gap:10,justifyContent:'center'}}><button onClick={startBreak} style={{...btnBase,background:'var(--success)',color:'#fff'}}>Start break</button><button onClick={keepGoing} style={{...btnBase,background:'transparent',border:'1px solid var(--accent)',color:'var(--accent)'}}>Keep going</button></div></div>}
      {!showBreakPrompt&&<div style={{display:'flex',gap:12,position:'relative',zIndex:1}}><button onClick={handleDone} style={{...btnBase,background:'var(--success)',color:'#fff'}}>Done ‚úì</button><button onClick={togglePause} style={{...btnBase,background:'transparent',border:'1px solid var(--accent)',color:'var(--accent)'}}>{isRunning?'Pause':'Resume'}</button><button onClick={onExit} style={{...btnBase,background:'transparent',border:'1px solid var(--border)',color:'var(--text-dim)'}}>Exit</button></div>}
      <div style={{position:'absolute',bottom:20,fontSize:'0.7rem',color:'var(--text-dim)'}}>Space to pause/resume ¬∑ Escape to exit</div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SOS MAIN APP
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App() {
  const [user, setUser] = useState(null);
  const [dataLoaded, setDataLoaded] = useState(false);

  // ‚îÄ‚îÄ Data stores ‚îÄ‚îÄ
  const [tasks, setTasks] = useState([]);
  const [blocks, setBlocks] = useState({ recurring: [], dates: {} });
  const [notes, setNotes] = useState([]);
  const [events, setEvents] = useState([]);
  const [messages, setMessages] = useState([]);
  const [weatherData, setWeatherData] = useState(null);
  const [weatherCoords, setWeatherCoords] = useState({ lat:42.33, lon:-71.21 });

  // ‚îÄ‚îÄ UI state ‚îÄ‚îÄ
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [chatError, setChatError] = useState(null);
  const [pendingActions, setPendingActions] = useState([]);
  const [pendingContent, setPendingContent] = useState([]);
  const [showPeek, setShowPeek] = useState(false);
  const [focusTaskId, setFocusTaskId] = useState(null);
  const [toastMsg, setToastMsg] = useState(null);
  const [syncStatus, setSyncStatus] = useState('saved'); // 'saving', 'saved', 'error'
  const [contentGenUsed, setContentGenUsed] = useState(0);
  const DAILY_CONTENT_LIMIT = 3;
  // Google OAuth state
  const [googleToken, setGoogleToken] = useState(() => {
    const t = sessionStorage.getItem('sos_google_token');
    const exp = Number(sessionStorage.getItem('sos_google_expiry') || 0);
    return (t && exp > Date.now()) ? t : null;
  });
  const [googleExpiry, setGoogleExpiry] = useState(() => Number(sessionStorage.getItem('sos_google_expiry') || 0));
  const [googleUser, setGoogleUser] = useState(null);
  const [showGoogleModal, setShowGoogleModal] = useState(false);
  const googleClientRef = useRef(null);

  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);
  const chatAreaRef = useRef(null);

  // ‚îÄ‚îÄ Auth handler ‚îÄ‚îÄ
  async function handleAuth(authUser) {
    setUser(authUser);
    // Migrate any existing localStorage data to Supabase
    const didMigrate = await migrateLocalStorage(authUser.id);
    if (didMigrate) setToastMsg('Migrated your existing data to the cloud ‚òÅÔ∏è');

    // Load all data from Supabase
    const data = await loadAllFromSupabase(authUser.id);
    if (data) {
      setTasks(data.tasks);
      setBlocks(data.blocks);
      setNotes(data.notes);
      setEvents(data.events);
      setMessages(data.messages);
      setWeatherCoords(data.weatherCoords);
    }

    // Fetch today's content generation count
    try {
      const now = new Date();
      const nyDate = now.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
      const { count } = await sb.from('content_generations')
        .select('*', { count:'exact', head:true })
        .eq('user_id', authUser.id)
        .gte('created_at', nyDate + 'T00:00:00-05:00');
      setContentGenUsed(count || 0);
    } catch(e) { console.error('Failed to fetch content gen count:', e); }

    setDataLoaded(true);
  }

  // ‚îÄ‚îÄ Listen for auth state changes (logout, token refresh) ‚îÄ‚îÄ
  useEffect(() => {
    const { data: { subscription } } = sb.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        setUser(null);
        setDataLoaded(false);
        setTasks([]); setBlocks({ recurring: [], dates: {} }); setNotes([]); setEvents([]); setMessages([]);
      }
    });
    return () => subscription.unsubscribe();
  }, []);

  // ‚îÄ‚îÄ Google OAuth initialization ‚îÄ‚îÄ
  useEffect(() => {
    if (!dataLoaded) return;
    let attempts = 0;
    function tryInit() {
      if (window.google?.accounts?.oauth2) {
        googleClientRef.current = window.google.accounts.oauth2.initTokenClient({
          client_id: '504839570150-i4sBurseqgrjucbhofjc9phiavcn08ad.apps.googleusercontent.com',
          scope: [
            'https://www.googleapis.com/auth/calendar.readonly',
            'https://www.googleapis.com/auth/documents.readonly',
            'https://www.googleapis.com/auth/drive.readonly',
            'https://www.googleapis.com/auth/userinfo.email',
          ].join(' '),
          callback: (resp) => {
            if (resp.access_token) {
              const expiry = Date.now() + ((resp.expires_in || 3600) * 1000);
              setGoogleToken(resp.access_token);
              setGoogleExpiry(expiry);
              sessionStorage.setItem('sos_google_token', resp.access_token);
              sessionStorage.setItem('sos_google_expiry', String(expiry));
              // Fetch the email for display
              fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': 'Bearer ' + resp.access_token }
              }).then(r => r.json()).then(info => {
                setGoogleUser({ email: info.email, name: info.name });
              }).catch(() => {});
              setToastMsg('Connected to Google ‚úì');
            }
          },
          error_callback: (e) => { console.error('Google auth error:', e); },
        });
        // Restore saved user email if token still valid
        if (googleToken) {
          fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { 'Authorization': 'Bearer ' + googleToken }
          }).then(r => r.ok ? r.json() : null).then(info => {
            if (info) setGoogleUser({ email: info.email, name: info.name });
          }).catch(() => {});
        }
      } else if (attempts < 20) {
        attempts++;
        setTimeout(tryInit, 500);
      }
    }
    tryInit();
  }, [dataLoaded]);

  function isGoogleConnected() { return !!googleToken && googleExpiry > Date.now(); }

  function connectGoogle() {
    if (googleClientRef.current) {
      googleClientRef.current.requestAccessToken({ prompt: isGoogleConnected() ? '' : 'consent' });
    } else {
      setToastMsg('Google not ready ‚Äî try again in a moment');
    }
  }

  function disconnectGoogle() {
    if (googleToken && window.google?.accounts?.oauth2) {
      window.google.accounts.oauth2.revoke(googleToken, () => {});
    }
    setGoogleToken(null); setGoogleExpiry(0); setGoogleUser(null);
    sessionStorage.removeItem('sos_google_token');
    sessionStorage.removeItem('sos_google_expiry');
    setToastMsg('Disconnected from Google');
  }

  // ‚îÄ‚îÄ Auto-scroll ‚îÄ‚îÄ
  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior:'smooth' }); }, [messages, isLoading, pendingActions, pendingContent]);

  // ‚îÄ‚îÄ Focus input on load ‚îÄ‚îÄ
  useEffect(() => { if (dataLoaded) setTimeout(() => inputRef.current?.focus(), 300); }, [dataLoaded]);

  // ‚îÄ‚îÄ Weather fetch ‚îÄ‚îÄ
  const fetchWeather = useCallback(async () => {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherCoords.lat}&longitude=${weatherCoords.lon}&current=temperature_2m,weathercode,windspeed_10m&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_probability_max&temperature_unit=fahrenheit&timezone=auto&forecast_days=3`;
      const res = await fetch(url); if (!res.ok) throw new Error('Weather fetch failed');
      const data = await res.json();
      setWeatherData({ current:data.current, daily:data.daily, fetchedAt:Date.now() });
    } catch(e) { console.error('Weather fetch error:', e); }
  }, [weatherCoords]);
  useEffect(() => { if (dataLoaded) { const stale = !weatherData?.fetchedAt || (Date.now() - weatherData.fetchedAt > 3600000); if (stale) fetchWeather(); } }, [dataLoaded]);

  // ‚îÄ‚îÄ Sync helper: wraps a DB write with sync status ‚îÄ‚îÄ
  async function syncOp(fn) {
    setSyncStatus('saving');
    try { await fn(); setSyncStatus('saved'); } catch(e) { console.error('Sync error:', e); setSyncStatus('error'); }
  }

  // ‚îÄ‚îÄ Update a single task and sync ‚îÄ‚îÄ
  function updateTask(taskId, updates) {
    setTasks(prev => {
      const next = prev.map(t => t.id === taskId ? { ...t, ...updates } : t);
      if (user) {
        const updated = next.find(t => t.id === taskId);
        if (updated) syncOp(() => dbUpsertTask(updated, user.id));
      }
      return next;
    });
  }

  // ‚îÄ‚îÄ Action executor (writes to Supabase) ‚îÄ‚îÄ
  function executeAction(action) {
    try {
      switch (action.type) {
        case 'add_task': {
          const task = { id:uid(), title:action.title||'Untitled', subject:action.subject||'', dueDate:action.due||today(), estTime:action.estimated_minutes||30, status:'not_started', focusMinutes:0, createdAt:new Date().toISOString() };
          setTasks(prev => [...prev, task]);
          if (user) syncOp(() => dbUpsertTask(task, user.id));
          break;
        }
        case 'complete_task':
          if (action.task_id) updateTask(action.task_id, { status:'done', completedAt:new Date().toISOString() });
          break;
        case 'update_task':
          if (action.task_id) {
            const upd = {};
            if (action.title) upd.title = action.title;
            if (action.due) upd.dueDate = action.due;
            if (action.estimated_minutes) upd.estTime = action.estimated_minutes;
            updateTask(action.task_id, upd);
          }
          break;
        case 'add_block': {
          const date = action.date || today();
          const [sh,sm] = (action.start||'00:00').split(':').map(Number);
          const [eh,em] = (action.end||'01:00').split(':').map(Number);
          setBlocks(prev => {
            const newDates = { ...(prev.dates||{}) };
            const dayBlocks = { ...(newDates[date]||{}) };
            let ch=sh, cm=sm;
            while (ch<eh||(ch===eh&&cm<em)) {
              const key = String(ch).padStart(2,'0')+':'+String(cm).padStart(2,'0');
              const data = { name:action.activity||'Block', category:action.category||'school' };
              dayBlocks[key] = data;
              if (user) syncOp(() => dbUpsertDateBlock(date, key, data, user.id));
              cm+=30; if(cm>=60){ch++;cm=0;}
            }
            newDates[date] = dayBlocks;
            return { ...prev, dates:newDates };
          });
          break;
        }
        case 'add_event': {
          const ev = { id:uid(), title:action.title||'Event', type:action.event_type||'other', subject:action.subject||'', date:action.date||today(), recurring:'none', createdAt:new Date().toISOString() };
          setEvents(prev => [...prev, ev]);
          if (user) syncOp(() => dbUpsertEvent(ev, user.id));
          break;
        }
        case 'add_note': {
          const tabName = action.tab_name||'SOS Note'; const content = action.content||'';
          setNotes(prev => {
            const existing = prev.findIndex(n => n.name.toLowerCase() === tabName.toLowerCase());
            if (existing >= 0) {
              const updated = prev.map((n,i) => i===existing ? { ...n, content:n.content+(n.content?'\n':'')+content, updatedAt:new Date().toISOString() } : n);
              if (user) syncOp(() => dbUpsertNote(updated[existing], user.id));
              return updated;
            }
            const newNote = { id:uid(), name:tabName, content, updatedAt:new Date().toISOString() };
            if (user) syncOp(() => dbUpsertNote(newNote, user.id));
            return [...prev, newNote];
          });
          break;
        }
        case 'break_task': {
          (action.subtasks||[]).forEach(st => {
            const task = { id:uid(), title:st.title||'Part', subject:action.parent_title||'', dueDate:st.due||today(), estTime:st.estimated_minutes||20, status:'not_started', focusMinutes:0, createdAt:new Date().toISOString() };
            setTasks(prev => [...prev, task]);
            if (user) syncOp(() => dbUpsertTask(task, user.id));
          });
          break;
        }
        case 'delete_task': {
          setTasks(prev => {
            const match = resolveTask(action.title || action.task_id, prev);
            if (!match) return prev;
            if (user) syncOp(() => dbDeleteTask(match.id, user.id));
            return prev.filter(t => t.id !== match.id);
          });
          break;
        }
        case 'delete_event': {
          setEvents(prev => {
            const match = resolveEvent(action.title || action.event_id, prev);
            if (!match) return prev;
            if (user) syncOp(() => sb.from('events').delete().eq('id', match.id).eq('user_id', user.id));
            return prev.filter(ev => ev.id !== match.id);
          });
          break;
        }
        case 'update_event': {
          setEvents(prev => {
            const match = resolveEvent(action.title || action.event_id, prev);
            if (!match) return prev;
            const next = prev.map(ev => ev.id === match.id ? {
              ...ev,
              ...(action.date && { date: action.date }),
              ...(action.event_type && { type: action.event_type }),
              ...(action.subject !== undefined && { subject: action.subject })
            } : ev);
            const updated = next.find(ev => ev.id === match.id);
            if (updated && user) syncOp(() => dbUpsertEvent(updated, user.id));
            return next;
          });
          break;
        }
        case 'delete_block':
          if (action.date && action.start) {
            const delDate = action.date;
            const [dsh,dsm] = (action.start).split(':').map(Number);
            const [deh,dem] = (action.end||action.start).split(':').map(Number);
            setBlocks(prev => {
              const newDates = { ...(prev.dates||{}) };
              const dayBlks = { ...(newDates[delDate]||{}) };
              let dch=dsh, dcm=dsm;
              while (dch<deh||(dch===deh&&dcm<dem)) {
                const key = String(dch).padStart(2,'0')+':'+String(dcm).padStart(2,'0');
                delete dayBlks[key];
                if (user) syncOp(() => dbUpsertDateBlock(delDate, key, null, user.id));
                dcm+=30; if(dcm>=60){dch++;dcm=0;}
              }
              newDates[delDate] = dayBlks;
              return { ...prev, dates:newDates };
            });
          }
          break;
        default: console.warn('Unknown action type:', action.type);
      }
    } catch(e) { console.error('Failed to execute action:', action, e); }
  }

  // ‚îÄ‚îÄ Confirmation handlers ‚îÄ‚îÄ
  function handleConfirmAction(idx, action) {
    executeAction(action);
    setPendingActions(prev => prev.filter((_,i)=>i!==idx));
    const name = action.title||action.activity||'Action';
    const verb = action.type?.startsWith('delete') ? 'removed' : action.type === 'update_event' ? 'updated' : action.type === 'complete_task' ? 'completed' : 'added';
    setToastMsg('‚úì ' + name + ' ' + verb);
  }
  function handleCancelAction(idx) { setPendingActions(prev => prev.filter((_,i)=>i!==idx)); }

  // ‚îÄ‚îÄ Content save/dismiss helpers ‚îÄ‚îÄ
  function formatContentForNote(c) {
    try {
      switch (c.type) {
        case 'create_flashcards':
          return (c.cards||[]).map((card,i) => 'Q' + (i+1) + ': ' + card.q + '\nA: ' + card.a).join('\n\n');
        case 'create_outline':
          return (c.sections||[]).map(s => '## ' + s.heading + '\n' + (s.points||[]).map(p => '- ' + p).join('\n')).join('\n\n');
        case 'create_summary':
          return (c.bullets||[]).map(b => '- ' + b).join('\n');
        case 'create_study_plan':
          return (c.steps||[]).map((s,i) => (i+1) + '. ' + s.step + ' (' + (s.time_minutes||20) + 'min' + (s.day ? ', ' + s.day : '') + ')').join('\n');
        case 'create_quiz':
          return (c.questions||[]).map((q,i) => 'Q' + (i+1) + ': ' + q.q + '\nChoices: ' + (q.choices||[]).join(' | ') + '\nAnswer: ' + q.answer).join('\n\n');
        case 'create_project_breakdown':
          return (c.phases||[]).map(p => '## ' + p.phase + (p.deadline ? ' (due ' + p.deadline + ')' : '') + '\n' + (p.tasks||[]).map(t => '- [ ] ' + t).join('\n')).join('\n\n');
        default: return JSON.stringify(c, null, 2);
      }
    } catch(e) { return JSON.stringify(c, null, 2); }
  }
  function handleSaveContent(idx) {
    const c = pendingContent[idx];
    if (!c) return;
    const formatted = formatContentForNote(c);
    executeAction({ type:'add_note', tab_name: c.title || 'Study Material', content: formatted });
    setPendingContent(prev => prev.filter((_,i) => i !== idx));
    setToastMsg('Saved "' + (c.title || 'content') + '" to notes');
  }
  function handleDismissContent(idx) { setPendingContent(prev => prev.filter((_,i) => i !== idx)); }

  // ‚îÄ‚îÄ Google import handlers ‚îÄ‚îÄ
  function handleImportGoogleEvents(gevents) {
    let count = 0;
    let skipped = 0;
    gevents.forEach(gev => {
      if (!gev.date) return;
      // Dedup: skip if an event with the same title + date already exists
      const dupTitle = (gev.title||'').toLowerCase();
      const isDup = events.some(ex => ex.title.toLowerCase() === dupTitle && ex.date === gev.date);
      if (isDup) { skipped++; return; }
      const ev = { id: uid(), title: gev.title, type: 'event', subject: '', date: gev.date, recurring: 'none', createdAt: new Date().toISOString(), source: 'google_calendar' };
      setEvents(prev => [...prev, ev]);
      if (user) syncOp(() => dbUpsertEvent(ev, user.id));
      count++;
    });
    setShowGoogleModal(false);
    const msg = 'Imported ' + count + ' event' + (count !== 1 ? 's' : '') + ' from Google Calendar üìÖ' + (skipped > 0 ? ' (' + skipped + ' duplicate' + (skipped !== 1 ? 's' : '') + ' skipped)' : '');
    setToastMsg(msg);
  }

  function handleImportGoogleDoc(title, text) {
    const note = { id: uid(), name: title, content: text, updatedAt: new Date().toISOString(), source: 'google_docs' };
    setNotes(prev => [...prev, note]);
    if (user) syncOp(() => dbUpsertNote(note, user.id));
    setShowGoogleModal(false);
    setToastMsg('Imported "' + title + '" to notes üìÑ');
  }

  function handleImportPdf(title, text) {
    const note = { id: uid(), name: title, content: text, updatedAt: new Date().toISOString(), source: 'pdf' };
    setNotes(prev => [...prev, note]);
    if (user) syncOp(() => dbUpsertNote(note, user.id));
    setShowGoogleModal(false);
    setToastMsg('Imported PDF "' + title + '" to notes üìë');
  }

  function autoConfirmPending() {
    if (pendingActions.length > 0) { pendingActions.forEach(a => executeAction(a.action)); setPendingActions([]); }
    if (pendingContent.length > 0) { pendingContent.forEach((c,i) => { const formatted = formatContentForNote(c); executeAction({ type:'add_note', tab_name: c.title || 'Study Material', content: formatted }); }); setPendingContent([]); }
  }

  // ‚îÄ‚îÄ Send message via Edge Function (multi-model routing) ‚îÄ‚îÄ
  async function sendMessage(text) {
    if (!text?.trim() || isLoading) return;
    autoConfirmPending();
    setChatError(null);

    const userMsg = { role:'user', content:text.trim(), timestamp:Date.now() };
    const updated = [...messages, userMsg];
    while (updated.length > CHAT_MAX_MESSAGES) updated.shift();
    setMessages(updated);
    setInput('');
    setIsLoading(true);

    if (user) dbInsertChatMsg('user', text.trim(), user.id);

    // Classify which model tier handles this message
    const routing = classifyMessage(text);

    try {
      const historyForApi = updated.slice(-12).map(m => ({ role:m.role, content:m.content }));
      const systemPrompt = buildSystemPrompt(tasks, blocks, events, notes, routing.tier);

      const session = await sb.auth.getSession();
      const token = session?.data?.session?.access_token;

      const response = await fetch(EDGE_FN_URL, {
        method:'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + (token || SUPABASE_ANON_KEY)
        },
        body: JSON.stringify({
          systemPrompt,
          messages: historyForApi,
          maxTokens: routing.maxTokens,
          model: routing.model,
          provider: routing.provider,
          isContentGen: routing.isContentGen
        })
      });

      if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        if (response.status === 429 && errData?.rateLimited) {
          const limitMsg = "hey, you've used all 3 content generations for today ‚Äî this resets at midnight EST. regular chat still works though, ask me anything else!";
          const assistantMsg = { role:'assistant', content:limitMsg, timestamp:Date.now() };
          setMessages(prev => { const n=[...prev,assistantMsg]; while(n.length>CHAT_MAX_MESSAGES)n.shift(); return n; });
          if (user) dbInsertChatMsg('assistant', limitMsg, user.id);
          setContentGenUsed(errData.used || DAILY_CONTENT_LIMIT);
          setIsLoading(false);
          return;
        }
        throw new Error(errData?.error || 'AI request failed: ' + response.status);
      }

      const data = await response.json();
      const rawContent = data?.content || "hmm, didn't get a response. try again?";

      if (routing.isContentGen) {
        setContentGenUsed(prev => prev + 1);
      }

      let actions = parseActions(rawContent);
      const displayContent = stripActionTags(rawContent);

      // ‚îÄ‚îÄ Fail-safe: Tier 2 action request but AI returned no action tags ‚îÄ‚îÄ
      if (routing.tier === 2 && !routing.isContentGen && actions.length === 0) {
        const fallback = inferActionFromMessage(text);
        if (fallback) {
          setPendingActions(prev => [...prev, { action:fallback, timestamp:Date.now(), isFallback:true }]);
        }
      }

      // ‚îÄ‚îÄ Resolve actions: translate AI names ‚Üí real IDs using resolveEvent/resolveTask ‚îÄ‚îÄ
      let resolutionFailed = false; // tracks if any action couldn't be resolved ‚Äî suppresses AI response if so
      const resolved = [];
      for (const a of actions) {
        if (a.type === 'delete_event' || a.type === 'update_event') {
          const match = resolveEvent(a.title || a.event_id, events);
          if (match) {
            resolved.push({ ...a, event_id: match.id, title: match.title });
          } else {
            resolutionFailed = true;
            const msg = { role:'assistant', content: a.type === 'delete_event'
              ? "hmm, I couldn't find that event to remove. what's the exact name?"
              : "I couldn't find that event to update. which one did you mean?", timestamp:Date.now() };
            setMessages(prev => { const n=[...prev,msg]; while(n.length>CHAT_MAX_MESSAGES)n.shift(); return n; });
          }
          continue;
        }
        if (a.type === 'delete_task') {
          const match = resolveTask(a.title || a.task_id, tasks);
          if (match) {
            resolved.push({ ...a, task_id: match.id, title: match.title });
          } else {
            resolutionFailed = true;
            const msg = { role:'assistant', content:"hmm, I couldn't find that task. what's the exact name?", timestamp:Date.now() };
            setMessages(prev => { const n=[...prev,msg]; while(n.length>CHAT_MAX_MESSAGES)n.shift(); return n; });
          }
          continue;
        }
        if (a.type === 'add_event') {
          const dupTitle = (a.title||'').toLowerCase();
          const dupDate = a.date || today();
          if (events.some(ev => ev.title.toLowerCase() === dupTitle && ev.date === dupDate)) continue;
        }
        resolved.push(a);
      }
      actions = resolved;

      if (actions.length > 0) {
        const confirmTypes = ['add_task','add_event','add_block','break_task','delete_task','delete_event','delete_block','update_event'];
        const needsConfirm = actions.filter(a => confirmTypes.includes(a.type));
        const contentActions = actions.filter(a => CONTENT_TYPES.includes(a.type));
        const autoExec = actions.filter(a => !confirmTypes.includes(a.type) && !CONTENT_TYPES.includes(a.type));
        autoExec.forEach(executeAction);
        if (needsConfirm.length > 0) setPendingActions(prev => [...prev, ...needsConfirm.map(a => ({ action:a, timestamp:Date.now() }))]);
        if (contentActions.length > 0) setPendingContent(prev => [...prev, ...contentActions]);
      }

      // Only show AI's text response if resolution didn't fail.
      // If it failed, the "not found" error message is already shown ‚Äî don't also show the AI saying "got it, removed it!"
      if (!resolutionFailed) {
        const assistantMsg = { role:'assistant', content:displayContent, timestamp:Date.now() };
        setMessages(prev => { const n=[...prev,assistantMsg]; while(n.length>CHAT_MAX_MESSAGES)n.shift(); return n; });
        if (user) dbInsertChatMsg('assistant', displayContent, user.id);
      }
    } catch(err) {
      console.error('Chat error:', err);
      setChatError(err.message || "couldn't reach the server ‚Äî check your connection");
    } finally { setIsLoading(false); }
  }

  function handleSubmit(e) { if(e)e.preventDefault(); sendMessage(input); }
  function sendChip(text) { setInput(''); sendMessage(text); }
  function clearChat() {
    setMessages([]); setPendingActions([]); setChatError(null);
    if (user) dbClearChat(user.id);
  }

  async function handleLogout() {
    await sb.auth.signOut();
  }

  // ‚îÄ‚îÄ Focus Mode ‚îÄ‚îÄ
  const focusTask = focusTaskId ? tasks.find(t=>t.id===focusTaskId) : null;
  function startFocusOnTop() {
    const active = tasks.filter(t=>t.status!=='done').sort((a,b)=>getPriority(a)-getPriority(b));
    if (active.length > 0) setFocusTaskId(active[0].id);
    else setToastMsg('No active tasks to focus on');
  }

  // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ
  useEffect(()=>{
    function handleKey(e){
      const tag=document.activeElement?.tagName?.toLowerCase();
      if(tag==='input'||tag==='textarea'||tag==='select')return;
      if(focusTaskId)return;
      const key=e.key.toLowerCase();
      if(key==='f'){e.preventDefault();startFocusOnTop()}
      else if(key==='/'){e.preventDefault();inputRef.current?.focus()}
      else if(key==='s'){e.preventDefault();setShowPeek(p=>!p)}
      else if(key==='escape'){if(showPeek)setShowPeek(false)}
    }
    window.addEventListener('keydown',handleKey);return()=>window.removeEventListener('keydown',handleKey);
  },[focusTaskId,showPeek,tasks]);

  // ‚îÄ‚îÄ Typing dots ‚îÄ‚îÄ
  const TypingDots=()=>(
    <div className="sos-msg sos-msg-ai" style={{padding:'6px 16px'}}>
      <div style={{background:'var(--card)',border:'1px solid var(--border)',borderRadius:16,borderBottomLeftRadius:4,padding:'12px 16px',display:'flex',gap:5,alignItems:'center'}}>
        {[0,1,2].map(i=>(<span key={i} style={{width:7,height:7,borderRadius:'50%',background:'var(--accent)',display:'inline-block',animation:'dotPulse 1.2s ease-in-out infinite',animationDelay:(i*0.2)+'s'}}/>))}
      </div>
    </div>
  );

  const quickChips = [
    { label:'What should I do?', msg:'What should I work on right now?' },
    { label:'Add a task', msg:'I need to add a task' },
    { label:'My schedule', action:()=>setShowPeek(true) },
    { label:'Focus mode', action:()=>startFocusOnTop() },
    { label:'Flashcards', msg:'Make me flashcards for what I studied last' },
    { label:'Quiz me', msg:'Quiz me on what I need to study' },
    { label:'üîó Import', action:()=>isGoogleConnected()?setShowGoogleModal(true):connectGoogle() },
  ];

  const activeTaskCount = tasks.filter(t=>t.status!=='done').length;
  const overdueCount = tasks.filter(t=>t.status!=='done'&&daysUntil(t.dueDate)<0).length;

  // ‚îÄ‚îÄ Not logged in ‚Üí show auth ‚îÄ‚îÄ
  if (!user) return <AuthScreen onAuth={handleAuth} />;

  // ‚îÄ‚îÄ Loading data ‚îÄ‚îÄ
  if (!dataLoaded) {
    return (
      <div className="auth-screen">
        <div style={{fontSize:'2rem',fontWeight:900,background:'linear-gradient(135deg, var(--accent), var(--teal))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:16}}>SOS</div>
        <div style={{width:24,height:24,border:'3px solid var(--border)',borderTopColor:'var(--accent)',borderRadius:'50%',animation:'spin 0.8s linear infinite'}}/>
        <div style={{marginTop:12,fontSize:'0.85rem',color:'var(--text-dim)'}}>Loading your data...</div>
      </div>
    );
  }

  // ‚îÄ‚îÄ Focus mode takes over ‚îÄ‚îÄ
  if (focusTask) {
    return <FocusMode task={focusTask} onUpdateTask={updateTask}
      onComplete={()=>{setFocusTaskId(null);setToastMsg('Task completed!')}}
      onExit={()=>setFocusTaskId(null)}/>;
  }

  return (
    <div className="sos-app">
      {/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */}
      <div className="sos-header">
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{fontSize:'1.15rem',fontWeight:800,letterSpacing:'-0.5px',background:'linear-gradient(135deg, var(--accent), var(--teal))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>SOS</div>
          <div style={{fontSize:'0.75rem',color:'var(--text-dim)',display:'flex',alignItems:'center',gap:4}}>
            <span className={'sync-dot '+(syncStatus==='saving'?'sync-saving':syncStatus==='error'?'sync-error':'sync-saved')}/>
            {syncStatus==='saving'?'Saving...':syncStatus==='error'?'Sync error':'Synced'}
          </div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          {activeTaskCount>0&&<div style={{fontSize:'0.75rem',color:overdueCount>0?'var(--danger)':'var(--text-dim)',display:'flex',alignItems:'center',gap:4}}><span style={{width:8,height:8,borderRadius:4,background:overdueCount>0?'var(--danger)':'var(--accent)',display:'inline-block'}}/>{activeTaskCount} task{activeTaskCount!==1?'s':''}{overdueCount>0&&<span style={{color:'var(--danger)'}}>({overdueCount} overdue)</span>}</div>}
          <button onClick={()=>setShowPeek(true)} title="View schedule (S)" style={{background:'rgba(108,99,255,0.1)',border:'1px solid rgba(108,99,255,0.25)',color:'var(--accent)',cursor:'pointer',borderRadius:8,padding:'5px 10px',fontSize:'0.78rem',fontWeight:600,transition:'all .2s'}}>üìã Peek</button>
          {isGoogleConnected() ? (
            <button onClick={()=>setShowGoogleModal(true)} className="g-hdr-btn connected" title="Import from Google Calendar, Docs, or Drive">
              <span>üîó</span> Import
            </button>
          ) : (
            <button onClick={connectGoogle} className="g-hdr-btn" title="Connect your Google account to import calendar events, docs, and PDFs">
              <span style={{fontWeight:900,fontSize:'0.85rem'}}>G</span> Connect
            </button>
          )}
          <div title="Content generations remaining today" style={{fontSize:'0.72rem',color:contentGenUsed>=DAILY_CONTENT_LIMIT?'var(--danger)':'var(--text-dim)',display:'flex',alignItems:'center',gap:3}}>
            <span style={{fontSize:'0.8rem'}}>‚ú®</span>
            <span style={{fontWeight:600}}>{Math.max(0, DAILY_CONTENT_LIMIT - contentGenUsed)}/{DAILY_CONTENT_LIMIT}</span>
          </div>
          {weatherData?.current&&<div style={{fontSize:'0.85rem',display:'flex',alignItems:'center',gap:4}}><span>{weatherEmoji(weatherData.current.weathercode)}</span><span style={{fontWeight:600,fontSize:'0.82rem'}}>{Math.round(weatherData.current.temperature_2m)}¬∞</span></div>}
          <button onClick={handleLogout} title="Sign out" style={{background:'transparent',border:'1px solid var(--border)',color:'var(--text-dim)',cursor:'pointer',borderRadius:8,padding:'5px 8px',fontSize:'0.72rem',transition:'all .2s'}}>Sign out</button>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Chat Area ‚îÄ‚îÄ */}
      <div className="sos-chat-area" ref={chatAreaRef}>
        {messages.length===0&&!isLoading&&(
          <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',padding:'40px 24px',textAlign:'center'}}>
            <div style={{fontSize:'2.8rem',marginBottom:12,background:'linear-gradient(135deg, var(--accent), var(--teal))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',fontWeight:900}}>SOS</div>
            <div style={{fontSize:'1rem',color:'var(--text)',fontWeight:600,marginBottom:6}}>hey, i'm your study sidekick</div>
            <div style={{fontSize:'0.88rem',color:'var(--text-dim)',maxWidth:380,lineHeight:1.6,marginBottom:28}}>tell me what's on your plate and i'll help you figure it out. i know your tasks, schedule, and events ‚Äî so just talk to me like a friend.</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:8,justifyContent:'center',maxWidth:400}}>
              {['I have a math test on Friday','What should I work on?','Make me flashcards for biology','Quiz me on chapter 3'].map(s=>(
                <button key={s} className="sos-chip" onClick={()=>sendChip(s)}>{s}</button>
              ))}
            </div>
          </div>
        )}
        {messages.map((msg,i)=>(
          <div key={i} className={`sos-msg ${msg.role==='user'?'sos-msg-user':'sos-msg-ai'}`}>
            <div className={`sos-bubble ${msg.role==='user'?'sos-bubble-user':'sos-bubble-ai'}`}>
              {msg.content}
              <div className="sos-bubble-time">{msg.timestamp?new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):''}</div>
            </div>
          </div>
        ))}
        {pendingActions.map((pa,idx)=>(
          <div key={'pa-'+idx} className="sos-msg sos-msg-ai" style={{padding:'6px 16px'}}>
            <ConfirmationCard action={pa.action} onConfirm={(action)=>handleConfirmAction(idx,action)} onCancel={()=>handleCancelAction(idx)} isFallback={pa.isFallback}/>
          </div>
        ))}
        {pendingContent.map((pc,idx)=>(
          <div key={'pc-'+idx} className="sos-msg sos-msg-ai" style={{padding:'6px 16px'}}>
            <ContentTypeRouter content={pc} onSave={()=>handleSaveContent(idx)} onDismiss={()=>handleDismissContent(idx)}/>
          </div>
        ))}
        {isLoading&&<TypingDots/>}
        {chatError&&<div style={{padding:'8px 16px'}}><div style={{padding:'10px 14px',borderRadius:12,background:'rgba(255,71,87,0.08)',border:'1px solid rgba(255,71,87,0.25)',fontSize:'0.84rem',color:'var(--danger)',maxWidth:'80%'}}>{chatError}</div></div>}
        <div ref={messagesEndRef} style={{height:1}}/>
      </div>

      {/* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */}
      <div className="sos-input-area">
        {messages.length>0&&(
          <div style={{display:'flex',gap:6,marginBottom:8,overflowX:'auto',paddingBottom:2}}>
            {quickChips.map((chip,i)=>(<button key={i} className="sos-chip" onClick={()=>chip.action?chip.action():sendChip(chip.msg)}>{chip.label}</button>))}
            <button className="sos-chip" onClick={clearChat} style={{background:'rgba(255,71,87,0.08)',borderColor:'rgba(255,71,87,0.2)',color:'var(--danger)'}}>Clear chat</button>
          </div>
        )}
        <form onSubmit={handleSubmit} style={{display:'flex',gap:8,alignItems:'center'}}>
          <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)}
            placeholder={messages.length===0?"what's on your plate today?":"type anything..."}
            disabled={isLoading}
            style={{flex:1,background:'var(--bg)',color:'var(--text)',border:'1px solid var(--border)',borderRadius:24,padding:'12px 20px',fontSize:'0.92rem',outline:'none',opacity:isLoading?0.5:1,transition:'all .2s'}}
            onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSubmit()}}}/>
          <button type="submit" disabled={isLoading||!input.trim()} style={{width:44,height:44,borderRadius:'50%',background:(isLoading||!input.trim())?'var(--border)':'var(--accent)',color:'#fff',border:'none',cursor:(isLoading||!input.trim())?'not-allowed':'pointer',fontSize:'1.1rem',display:'flex',alignItems:'center',justifyContent:'center',transition:'all .2s',flexShrink:0}}>‚û§</button>
        </form>
        <div style={{display:'flex',justifyContent:'center',gap:16,marginTop:6,fontSize:'0.68rem',color:'var(--text-dim)'}}><span>/ to focus input</span><span>S for schedule</span><span>F for focus mode</span></div>
      </div>

      {showPeek&&<SchedulePeek tasks={tasks} blocks={blocks} events={events} weatherData={weatherData} onClose={()=>setShowPeek(false)}/>}
      {showGoogleModal && isGoogleConnected() && (
        <GoogleImportModal
          googleToken={googleToken}
          googleUser={googleUser}
          onClose={()=>setShowGoogleModal(false)}
          onImportEvents={handleImportGoogleEvents}
          onImportDoc={handleImportGoogleDoc}
          onImportPdf={handleImportPdf}
          onDisconnect={()=>{ disconnectGoogle(); setShowGoogleModal(false); }}
        />
      )}
      {toastMsg&&<Toast message={toastMsg} onDone={()=>setToastMsg(null)}/>}
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ Mount ‚îÄ‚îÄ‚îÄ */
try {
  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
} catch (e) {
  document.getElementById('root').innerHTML = '<div style="padding:40px;text-align:center;color:#ff4757;font-family:sans-serif"><h2>Failed to load SOS</h2><p>' + e.message + '</p></div>';
}
</script>
</body>
</html>
